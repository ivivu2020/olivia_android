import { Component, OnInit, NgZone, ViewChild, ElementRef } from '@angular/core';
import { AuthService } from '../providers/auth-service';
import * as request from 'requestretry';
import { Storage } from '@ionic/storage';
import { C } from './../providers/constants';
import { GlobalFunction } from './../providers/globalfunction';
import * as $ from 'jquery';
import * as moment from 'moment';
import { ActionSheetController, NavController, ModalController, Platform, IonContent, AlertController, IonSlides, IonInfiniteScroll, ToastController } from '@ionic/angular';
import { ExperienceFilterPage } from '../experiencefilter/experiencefilter.page';
import { OverlayEventDetail } from '@ionic/core';
import { DomSanitizer } from '@angular/platform-browser';
import { Geolocation } from '@ionic-native/geolocation/ngx';
import { Map, tileLayer, marker, icon,latLng } from 'leaflet';
import * as L from 'leaflet';
import 'leaflet-routing-machine';
import { map } from 'rxjs/operators';
import { ExperienceDetailPage } from '../experiencedetail/experiencedetail.page';
import { SearchHotel } from '../providers/book-service';
import { DrawerState } from 'ion-bottom-drawer';
import { AndroidPermissions } from '@ionic-native/android-permissions/ngx';
import { LocationAccuracy } from '@ionic-native/location-accuracy/ngx';
import { NativeGeocoder, NativeGeocoderResult, NativeGeocoderOptions } from '@ionic-native/native-geocoder/ngx';
import { SocialSharing } from '@ionic-native/social-sharing/ngx';
import { google } from 'google-maps';
import * as MarkerClusterer from "@google/markerclusterer";
//import * as MarkerWithLabel from 'src/markerwithlabel';
declare const H;
declare var google;
declare var mc;
var popup,Popup;

@Component({
  selector: 'app-experiencesearch',
  templateUrl: './experiencesearch.page.html',
  styleUrls: ['./experiencesearch.page.scss'],
})
export class ExperienceSearchPage implements OnInit {
  shouldBounce = true;
  dockedHeight = 300;
  distanceTop = 90;
  drawerState = DrawerState.Docked;
  states = DrawerState;
  minimumHeight = 72;
  dashScrollDisabled = false;

  slideOpts = {
    slidesPerView: 1.1,
    spaceBetween: 8,
    centeredSlides: true
  };

  @ViewChild('scrollArea') content: IonContent;
  @ViewChild('myFloatSlider') slider: IonSlides;
  @ViewChild(IonInfiniteScroll) infiniteScroll: IonInfiniteScroll;
  @ViewChild('mapContainer') mapContainer: ElementRef;
  herePlatform;
  region = 'phú quốc';
  linkMap:any;
  canLoadBlog: boolean=true;
  pageCount=0;
  pageSize=500;
  totalPage=0;
  listBlog=[];
  showloadmoreblog: boolean= true;
  arrbloglike=[];
  blog=[];
  map:any;
  googleMap: any;
  latlng: any;
  geocoder:any;
  listEmpty = [1,2,3,4,5];
  
  listRestaurant = [{ id: 1, name: 'BoatHouse Restaurant, Khu đô thị An Phú, Thao Dien, District 2, Ho Chi Minh City',lat: 10.8092809, long: 106.7355885 },
    { id: 2, name: 'Khu Phan Xích Long (quận Phú Nhuận)',lat: 10.7992354, long: 106.6848483 },
    { id: 3, name: 'Khu phố Tây Bùi Viện (quận 1)',lat: 10.7679735, long: 106.6934983 },
    { id: 4, name: 'Khu Vĩnh Viễn (quận 10)',lat: 10.7634253, long: 106.6642136 },
    { id: 5, name: 'Khu Hà Tôn Quyền (quận 5)',lat: 10.7567114, long: 106.6517515 },
    { id: 6, name: 'Khu Hàng Xanh (quận Bình Thạnh)',lat: 10.8045888, long: 106.7054792 }
  ]
  textsearch: string='';
  curLat: number;
  curLng: number;
  markers: L.Marker<any>[] = [];
  markersSelected: L.Marker<any>[] = [];
  routings: L.Routing.Control [] = [];
  listSuggests: any=[];
  regionCode: any;
  listSearch: any=[];
  listSearchOriginal: any=[];
  listSearchDisplay: any=[];
  itemclick: boolean = false;
  sort=1;//1 - ascending; -1- descending
  filterHourOpen=1;//1 - filter; -1 clear filter
  regionId: any;
  markersOriginal: L.Marker<any>[];
  curType: any;
  locationCoords: any;
  devicePlatform: any;
  recent: any;
  countfilter = 0;
  requestGPS: boolean = false;
  actionSheet: any;
  dataListLike: any;
  username: string;
  _infiniteScroll: any;
  routesHidden: any=[];
  sortvalue: any;
  markerhaschange: boolean;
  slidehaschange: boolean;
  loaddatadone: boolean=false;
  url ='';
  styles = {
    default: null,
    hide: [
      {
        featureType: 'poi.business',
        stylers: [{visibility: 'off'}]
      },
      {
        featureType: 'transit',
        elementType: 'labels.icon',
        stylers: [{visibility: 'off'}]
      }
    ]
  };
  deviceLocation={
    latitude: null,
    longitude: null,
    regioncode: ''
  };
  itemsearchfocus: any;

  subRegionLocation={
    latitude: null,
    longitude: null,
    regioncode: ''
  };
  dataafterfilter: any = [];
  
  constructor(private storage: Storage, private zone: NgZone,
    private navCtrl: NavController,
    private actionSheetCtrl: ActionSheetController,
    private gf: GlobalFunction,
    private modalCtrl: ModalController,
    private sanitizer: DomSanitizer,
    private platform: Platform,
    private geolocation: Geolocation,
    public searchhotel: SearchHotel,
    private androidPermissions: AndroidPermissions,
    private locationAccuracy: LocationAccuracy,
    private nativeGeocoder: NativeGeocoder,
    private alertCtrl: AlertController,
    private socialSharing: SocialSharing,
    private toastCtrl: ToastController,
    //private googleMap: GoogleMap
    ) { 
      this.locationCoords = {
        latitude: "",
        longitude: "",
        accuracy: "",
        timestamp: "",
        address:""
      }

      // this.platform.ready().then(()=>{
      //   if(cordova){
      //     this.devicePlatform = cordova.platformId;
      //   }
      // })
      storage.get('username').then(username => {
        this.username = username;
       });
    }

  ngOnInit() {
   
  }

  goback(){
    var se = this;
    if(se.actionSheet){
      se.actionSheet.dismiss();
    }
    $('.float-search-white-bar').addClass('float-disable');
    $('.item-filter-top').addClass('float-disable');
    $('.float-search-top').addClass('float-disable');
    $('.float-search').addClass('float-disable');
    se.navCtrl.navigateBack('/');
  }

  ionViewWillEnter(){
    var se=this;
    if(!se.searchhotel.inputExperienceItem){
      let sfilter='',tags='';
      se.searchhotel.ef_arrlocalnamecheck = [];
      se.searchhotel.ef_arrlocalcheck = [];
      se.checkGPSPermission();
    }else{
      se.requestGPS = true;
      se.loadDataAfterSearchItem();
    }
   
    se.countfilter= 0;
  }

  buildStringFilterName(sfilterName){
    var se = this;
    if(se.searchhotel.ef_arrlocalnamecheck.length >0){
      for(let i =0; i<se.searchhotel.ef_arrlocalnamecheck.length; i++){
        if(i==0){
          sfilterName += se.searchhotel.ef_arrlocalnamecheck[i];
        }else{
          sfilterName += ", " + se.searchhotel.ef_arrlocalnamecheck[i];
        }
      }
    }

    if(se.searchhotel.ef_arrsubregionnamecheck.length >0){
      for(let i =0; i<se.searchhotel.ef_arrsubregionnamecheck.length; i++){
        if(i==0){
          sfilterName += se.searchhotel.ef_arrsubregionnamecheck[i];
        }else{
          sfilterName += ", " + se.searchhotel.ef_arrsubregionnamecheck[i];
        }
      }
    }

    if(se.searchhotel.ef_arrhoteltypenamecheck.length >0){
      for(let i =0; i<se.searchhotel.ef_arrhoteltypenamecheck.length; i++){
        if(i==0){
            if(sfilterName.length>0){
              sfilterName += ' | '+ se.searchhotel.ef_arrhoteltypenamecheck[i];
            }else{
              sfilterName += se.searchhotel.ef_arrhoteltypenamecheck[i];
            }
          }else{
            sfilterName += ", " + se.searchhotel.ef_arrhoteltypenamecheck[i];
          }
        }
      }

      if(se.searchhotel.ef_arrhouropennamecheck.length >0){
        for(let i =0; i<se.searchhotel.ef_arrhouropennamecheck.length; i++){
          if(i==0){
              if(sfilterName.length>0){
                sfilterName += ' | '+ se.searchhotel.ef_arrhouropennamecheck[i];
              }else{
                sfilterName += se.searchhotel.ef_arrhouropennamecheck[i];
              }
            }else{
              sfilterName += ", " + se.searchhotel.ef_arrhouropennamecheck[i];
            }
          }
        }

        if(se.searchhotel.ef_arrdistancenamecheck.length >0){
          for(let i =0; i<se.searchhotel.ef_arrdistancenamecheck.length; i++){
            if(i==0){
                if(sfilterName.length>0){
                  sfilterName += ' | '+ se.searchhotel.ef_arrdistancenamecheck[i];
                }else{
                  sfilterName += se.searchhotel.ef_arrdistancenamecheck[i];
                }
              }else{
                sfilterName += ", " + se.searchhotel.ef_arrdistancenamecheck[i];
              }
            }
          }

          if(se.searchhotel.ef_arrstylenamecheck.length >0){
            for(let i =0; i<se.searchhotel.ef_arrstylenamecheck.length; i++){
              if(i==0){
                  if(sfilterName.length>0){
                    sfilterName += ' | '+ se.searchhotel.ef_arrstylenamecheck[i];
                  }else{
                    sfilterName += se.searchhotel.ef_arrstylenamecheck[i];
                  }
                }else{
                  sfilterName += ", " + se.searchhotel.ef_arrstylenamecheck[i];
                }
              }
            }

    return sfilterName;
  }

  loadDataAfterSearchItem(){
    var se = this;
      se.pageCount =0;
      se.totalPage = 0;
      se.textsearch='';
      se.listSearchOriginal=[];
      se.listSearch=[];
      se.listSearchDisplay=[];
      se.loaddatadone = false;
      se.sortvalue = null;
      se.filterHourOpen = 1;
      se.content.scrollToTop(50);
      //Chọn item region => fill lại data theo region code
      //chọn item place => fill data theo regionid
      //if(se.searchhotel.inputExperienceRegionCode){
        var tags ='';
        // if(se.searchhotel.experiencesearchTagsId){
        //   tags = se.searchhotel.experiencesearchTagsId;
        // }
        se.getTagByTypeName();
        tags += se.buildFilter();
        se.buildTextSearch();
        if(se.searchhotel.inputExperienceItem){
          if(se.searchhotel.inputExperienceItem.tagsJson && se.searchhotel.inputExperienceItem.tagsJson.length >0){
            let tag = se.searchhotel.inputExperienceItem.tagsJson[0].id;
            if(tags.indexOf(tag) == -1){
              se.searchhotel.ef_arrhoteltypecheck.push(tag);
              if(tags.length >0){
                tags+=','+tag;
              }else{
                tags+=tag;
              }
            }
          }
          if(se.searchhotel.inputExperienceItem.regionCode){
            se.regionCode = se.searchhotel.inputExperienceItem.regionCode;
          }
          else if(se.searchhotel.inputExperienceItem.code){
            se.regionCode = se.searchhotel.inputExperienceItem.code;
          }

          let urlApi = '';
          if(se.regionCode){
            if(se.regionCode == 'ho-chi-minh' || se.regionCode == 'Thanh-Pho-Ho-Chi-Minh' || se.regionCode == 'Ho-Chi-Minh-City'){
              se.regionCode = 'ho-chi-minh';
            }
            if(se.regionCode == 'quang-nam'){
              se.regionCode = 'hoi-an';
            }
            if(se.regionCode == 'vinh-ha-long'){
              se.regionCode = 'ha-long';
            }
            if(tags != '' && tags != ','){
              se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionCodes='+se.regionCode+'&Tags='+tags;
              urlApi = se.url +'&paging.pageNumber='+se.pageCount+'&paging.pageSize='+se.pageSize;
            }else{
              se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionCodes='+se.regionCode;
              urlApi = se.url +'&paging.pageNumber='+se.pageCount+'&paging.pageSize='+se.pageSize;
            }
            
          }else if(!se.loaddatadone){
            if(tags != '' && tags != ','){
              se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionId='+se.searchhotel.inputExperienceItem.regionId+'&Tags='+tags;
              urlApi = se.url +'&paging.pageNumber='+se.pageCount+'&paging.pageSize='+se.pageSize;
            }else{
              se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionId='+se.searchhotel.inputExperienceItem.regionId;
              urlApi = se.url +'&paging.pageNumber='+se.pageCount+'&paging.pageSize='+se.pageSize;
            }
          }

          if(se.searchhotel.inputExperienceItem.subRegionId){
            urlApi = urlApi + '&subRegions='+se.searchhotel.inputExperienceItem.subRegionId;
            if((se.searchhotel.ef_arrsubregioncheck.length >0 && !se.gf.checkExistsIndex(se.searchhotel.ef_arrsubregioncheck,se.searchhotel.inputExperienceItem.subRegionId)
                || se.searchhotel.ef_arrsubregioncheck.length == 0)
                ){
                
                se.searchhotel.ef_arrsubregioncheck.push(se.searchhotel.inputExperienceItem.subRegionId);
                se.searchhotel.ef_arrsubregionnamecheck.push(se.searchhotel.inputExperienceItem.name);
              }
          }
            
            se.gf.RequestApi('GET',urlApi,{},{},'ExperienceSearch', 'loadDataAfterSearchItem').then((data:any)=>{
            if(data && data.data.length >0){
              // if(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.subRegionId
              //   && ((se.searchhotel.ef_arrsubregioncheck.length >0 && !se.gf.checkExistsIndex(se.searchhotel.ef_arrsubregioncheck,se.searchhotel.inputExperienceItem.subRegionId))
              //   || se.searchhotel.ef_arrsubregioncheck.length == 0)
              //   ){
                
              //   se.searchhotel.ef_arrsubregioncheck.push(se.searchhotel.inputExperienceItem.subRegionId);
              //   se.searchhotel.ef_arrsubregionnamecheck.push(se.searchhotel.inputExperienceItem.name);
              // }
              
            se.combineDataPlace(se.regionCode,data.data).then((datacombine)=>{
              //data.data = datacombine;
              se.locationCoords.latitude = se.searchhotel.inputExperienceItem.latitude ? se.searchhotel.inputExperienceItem.latitude : data.data[0].latitude;
              se.locationCoords.longitude = se.searchhotel.inputExperienceItem.longitude ? se.searchhotel.inputExperienceItem.longitude: data.data[0].longitude;
              se.calculateDistanceMapData(datacombine).then((data)=>{ 
                data = se.combineFilterAndCount(data);
                datacombine = data;

                if(data && data.length ==0){
                  se.loaddatadone = true;
                  se.clearMarkerAndRouting();
                  se.initEmptyMap();
                  se.reCountFilter();
                  se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
                  return;
                }

                //Thêm regionName nếu chưa có trên textsearch
                let rn = data[0].regionName;
                if(se.textsearch.indexOf(rn) == -1 && !se.searchhotel.inputExperienceRegionName){
                    if(data[0].address){
                      let arrAddress = data[0].address.split(',');
                      let rn = arrAddress[arrAddress.length -2];
                      if(se.textsearch.indexOf(rn) == -1 && !se.searchhotel.inputExperienceRegionName){
                        if(se.textsearch.length >0){
                          se.textsearch += ' | '+ rn.trimLeft();
                        }else{
                          se.textsearch += rn.trimLeft() + " (" +data.length+ ")";
                        }
                        
                    }
                  }
                }
               
              if( !(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.placeId) ){
                if(se.textsearch.length >0 && !se.searchhotel.inputExperienceItem.latitude){
                  se.textsearch += " (" + datacombine.length + ")";
                }
                 
              }
              
              

              //vào trang chi tiết nếu chọn 1 địa điểm ko phải vùng
              if(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.placeId){
                var itemmap = datacombine.filter((item:any)=>{
                  return item.id == se.searchhotel.inputExperienceItem.placeId;
                })
                if(itemmap && itemmap.length>0){
                  se.itemListSearchClick(itemmap[0], datacombine);
                  setTimeout(()=>{
                    se.bindHourOpenAndAdressAndDistance(itemmap[0]);
                  },500)
                  
                }else{
                  se.itemListSearchClick(se.searchhotel.inputExperienceItem, datacombine);
                  setTimeout(()=>{
                    se.bindHourOpenAndAdressAndDistance(se.searchhotel.inputExperienceItem);
                  },500)
                }
                
              }
              // else if(se.textsearch.length >0 && !se.searchhotel.inputExperienceItem.latitude){
              //     se.textsearch += " (" + datacombine.length + ")";
              // }
                se.dockedHeight = 300;
                se.loaddatadone = true;
                se.setDockState();
                se.zone.run(()=>{
                  se.totalPage = Math.round(datacombine.length/5);
                })
                
                se.storage.get('auth_token').then(auth_token => {
                  if (auth_token) {
                      var text = "Bearer " + auth_token;
                      let urlLike = C.urls.baseUrl.urlMobile + '/api/Data/GetPlaceUserLike';
                      se.gf.RequestApi('GET', urlLike, {authorization: text}, {}, 'ExperienceSearch','GetPlaceUserLike').then((datalike:any) =>{
                        if(datalike && datalike.length >0){
                          se.dataListLike = datalike;
                          datacombine.forEach(element => {
                            element.liked = se.checkItemLiked(element.id) ? true: false;
                          });
                          
                          se.loadDataMap(datacombine);
                        }else{
                          se.loadDataMap(datacombine);
                        }
                      })
                    }else{
                      se.loadDataMap(datacombine);
                    }
                })
              }) 
               });
            }else{
              if(se.regionCode == 'vinh-ha-long'){
                se.regionCode = 'ha-long';
              }
              if(!se.searchhotel.inputExperienceItem.latitude){
              //Nếu item search theo item place thì lấy theo vị trí place
              //Nếu search theo vùng thì lấy vị trí theo place đầu tiên của list place theo vùng
              $.get('https://nominatim.openstreetmap.org/search?format=json&q='+se.regionCode, function(data){
                  if(data && data.length>0){
                    if(se.regionCode == 'vinh-ha-long'){
                      se.locationCoords.latitude = data[1].lat;
                      se.locationCoords.longitude = data[1].lon;
                    }else{
                      se.locationCoords.latitude = data[0].lat;
                      se.locationCoords.longitude = data[0].lon;
                    }
                    se.clearMarkerAndRouting();
                    se.initEmptyMap();
                    if(se.deviceLocation.latitude && se.deviceLocation.longitude && se.deviceLocation.regioncode == se.regionCode){
                      se.bindGPSLocationMarker()
                    }else{
                      se.bindCurrentLocationMarker();
                    }
                    se.setBottomState();
                    se.loaddatadone = true;
                    se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
                  }
                })
              }else{
                se.locationCoords.latitude = se.searchhotel.inputExperienceItem.latitude ? se.searchhotel.inputExperienceItem.latitude : data[0].latitude;
                se.locationCoords.longitude = se.searchhotel.inputExperienceItem.longitude ? se.searchhotel.inputExperienceItem.longitude: data[0].longitude;
                se.clearMarkerAndRouting();
                se.initEmptyMap();
                if(se.deviceLocation.latitude && se.deviceLocation.longitude && se.deviceLocation.regioncode == se.regionCode){
                  se.bindGPSLocationMarker()
                }else{
                  se.bindCurrentLocationMarker();
                }
                se.setBottomState();
                se.loaddatadone = true;
                se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
              }

              se.reCountFilter();
            }
          })
        }else{
          se.getLocationCoordinates();
        }
  }

  //Get current coordinates of device
  getGeolocation(){
    this.geolocation.getCurrentPosition().then((resp) => {
      this.locationCoords.latitude = resp.coords.latitude;
      this.locationCoords.longitude = resp.coords.longitude; 
      this.locationCoords.accuracy = resp.coords.accuracy; 

      this.deviceLocation.latitude = resp.coords.latitude;
      this.deviceLocation.longitude = resp.coords.longitude;
      this.getGeoencoder(resp.coords.latitude,resp.coords.longitude);
     }).catch((error) => {
       alert('Error getting location'+ JSON.stringify(error));
     });
  }

  //geocoder method to fetch address from coordinates passed as arguments
  getGeoencoder(latitude,longitude){
    this.nativeGeocoder.reverseGeocode(latitude, longitude, {
      useLocale: true,
      maxResults: 5
    })
    .then((result: any) => {
      this.locationCoords.address = this.generateAddress(result[0]);
    })
    .catch((error: any) => {
      alert('Error getting location'+ JSON.stringify(error));
    });
  }

  //Return Comma saperated address
  generateAddress(addressObj){
      let obj = [];
      let address = "";
      for (let key in addressObj) {
        obj.push(addressObj[key]);
      }
      obj.reverse();
      for (let val in obj) {
        if(obj[val].length)
        address += obj[val]+', ';
      }
    return address.slice(0, -2);
  }

  ionViewWillLeave(){
    var se = this;
    se.textsearch = '';
    se.regionCode='';
    se.countfilter = 0;
    se.loaddatadone=false;
    se.dockedHeight=0;
  }

  getListSuggestByRegionCode(regionCode,tags){
    var se = this,
    urlSuggest='';
    tags='';
    se.pageCount = 0;
    //se.content.scrollToTop(200);
    $('.div-float-item-search').removeClass('float-visible').addClass('float-disable');
    if(regionCode){
      tags += se.buildFilter();
      se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionCodes='+regionCode;
      urlSuggest =  se.url + (tags ? '&Tags='+tags : '')+'&paging.pageNumber='+se.pageCount+'&paging.pageSize='+se.pageSize;
      se.gf.RequestApi('GET',urlSuggest,{},{},'ExperienceSearch', 'getListSuggestByRegionCode').then((data:any)=>{
        if(data && data.data.length >0){
          se.combineDataPlace(regionCode,data.data).then((datacombine)=>{
            if( !(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.placeId) ){
              se.calculateDistanceMapData(datacombine).then((data)=>{
                if(data && data.length ==0){
                  se.loaddatadone = true;
                  se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
                  return;
                }
                  data= se.combineFilterAndCount(data);
                 datacombine = data;
                 
                });
            }
            
          se.textsearch += " (" + datacombine.length + ")";
          se.zone.run(()=>{
            se.loaddatadone = true;
            se.totalPage = Math.round(datacombine.length/5);
          })
          se.storage.get('auth_token').then(auth_token => {
            if (auth_token) {
                var text = "Bearer " + auth_token;
                let urlLike = C.urls.baseUrl.urlMobile + '/api/Data/GetPlaceUserLike';
                se.gf.RequestApi('GET', urlLike, {authorization: text}, {}, 'ExperienceSearch','GetPlaceUserLike').then((datalike:any) =>{
                  if(datalike && datalike.length >0){
                    se.dataListLike = datalike;
                    datacombine.forEach(element => {
                      element.liked = se.checkItemLiked(element.id) ? true: false;
                    });
                    se.bindDataListSuggest(datacombine);
                  }else{
                    se.bindDataListSuggest(datacombine);
                  }
                })
              }else{
                se.bindDataListSuggest(datacombine);
              }
          })
          }) 
          
        }else{
          se.loaddatadone = true;
          se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
        }
        
      })
    }
  }

  bindDataListSuggest(data){
    var se = this;
    se.reCountFilter();
    se.listSearch = data;
    se.listSearchOriginal = data;
    se.sortDataNearBy(data).then((data:any)=>{
      se.bindMarker(data,'');
    });
    
  }

  async sortDataNearBy(data){
    var se = this;
    return new Promise((resolve,reject)=>{
      let sortColumn = 'totalDistance';
      data.forEach(rest =>{
        se.calculateDistanceMarker(rest,sortColumn,'');
        se.bindShortAdress(rest);
      })
  
      setTimeout(()=>{
        if (data && data.length > 0) {
          se.zone.run(() => data.sort(function (a, b) {
            let direction = -1;
              if(a[sortColumn] && b[sortColumn] && a[sortColumn]*1 < b[sortColumn]*1){
                return 1 * direction;
              }else{
                return -1 * direction;
              }
          }));
        }
      },100)

      setTimeout(()=>{
        resolve(data);
      },300)
    })
  }

  initEmptyMap(){
    var se = this;
   
    var options = { 
      zoom: 15, 
      center: new google.maps.LatLng(se.locationCoords.latitude,se.locationCoords.longitude), 
      disableDefaultUI: true,
      mapTypeControl: false,
      mapTypeId: google.maps.MapTypeId.ROADMAP 
      }; 
      
      // Creating the map 
      se.map = new google.maps.Map(se.mapContainer.nativeElement, options); 

      $('.gm-svpc').css('display', 'none');
      $('.gmnoprint').css('display', 'none');
      //hide default map element
      se.map.setOptions({styles: se.styles['hide']});
  }

  initMap(){
    var se = this;

    var options = { 
      zoom: 15, 
      center: new google.maps.LatLng(se.locationCoords.latitude,se.locationCoords.longitude), 
      disableDefaultUI: true,
      mapTypeControl: false,
      mapTypeId: google.maps.MapTypeId.ROADMAP 
      }; 
      
      // Creating the map 
      se.map = new google.maps.Map(se.mapContainer.nativeElement, options); 

      $('.gm-svpc').css('display', 'none');
      $('.gmnoprint').css('display', 'none');
      //hide default map element
      se.map.setOptions({styles: se.styles['hide']});
      
      
      se.clearMarkerAndRouting();
      if(se.deviceLocation.latitude && se.deviceLocation.longitude && se.deviceLocation.latitude == se.locationCoords.latitude){
        se.bindGPSLocationMarker()
      }else{
        se.bindCurrentLocationMarker(); 
      }
  }

  animateMap(isShow){
    if(isShow){
      $('.content-search').removeClass('cls-hidden').addClass('cls-visible');
      $('.list-search-item').css('display', 'none');
      $('.item-filter').css('display', 'none');
    }else{
      $('.content-search').removeClass('cls-visible').addClass('cls-hidden');
      
      $('.item-filter').css('display', 'block');
      $('.list-search-item').css('display', 'block');
    }
  }

  bindMarker(data,type){
    var se = this;
    se.zone.run(()=>{
      //se.listSearch = data;
      let index = 0;
      se.listSearch.forEach(element => {
          if(!se.gf.checkExistsItemInArray(se.listSearchDisplay, element, 'experiencesearch') && index < 5){
            if(element.workingHours.length >0){
              element.workingHoursDisplay = '';
              //element.workingHoursDisplay = element.workingHours[0].name + ' | '+ element.workingHours[0].timeFrom + '-'+ element.workingHours[0].timeTo;
              element.workingHours.forEach(elementsub => {
                if(!element.workingHoursDisplay){
                  element.workingHoursDisplay = elementsub.name + ' | '+ elementsub.timeFrom + '-'+ elementsub.timeTo;
                }else{
                  element.workingHoursDisplay += " , " + elementsub.name + ' | '+ elementsub.timeFrom + '-'+ elementsub.timeTo;
                }
              });
            }
              se.listSearchDisplay.push(element);
              index++;
          }
        });

        se.listSearchDisplay.forEach(rest =>{
          se.calculateDistanceMarker(rest,'totalDistance', null);
          se.bindShortAdress(rest);
        })

        setTimeout(()=>{
          //se.loaddatadone = true;
          se.listSearchDisplay.forEach(element => {
            se.addMarkersToMap(element);
          });
        },50)

        // setTimeout(()=>{
        //   let i =0;
        //   se.listSearchDisplay.forEach(element => {
        //     if(i==0){
        //       se.setCurrentMarkerSelected(element)
        //     }
        //     i++
        //   });
        // },200)
    })
    if(se.sortvalue && se.sortvalue != 5){
      setTimeout(()=>{
        se.sortData(se.sortvalue);
      },150)
    }
    se.loaddatadone = true;
  }

  addMarkersToMap(item){
    var se = this;
    if(item && item.id){
      if($('#'+item.id).length >0){
        $('#'+item.id)[0]['style']['display']= 'block';
        $('#'+item.id).click((event)=>{
          var idx=-1;
          idx = se.listSearchDisplay.findIndex((m:any)=>{ return m.id == item.id});
            if(idx != -1 && idx != null){
              se.slider.slideTo(idx);
            }
        })
      }
      
      Popup = se.createPopupClass();
      popup = new Popup(
          new google.maps.LatLng(item.latitude, item.longitude),
          document.getElementById(item.id));
      popup.setMap(se.map);
    
    }
    
  }

  addInfoWindow(marker, item) {
    var se = this;
    // google.maps.event.addListener(marker, 'click', () => {
    //   se.markerClick(marker, item, se.map, false);
    // });
    google.maps.event.addListener(marker, 'click', () => {
      se.markerClick(marker, item, se.map, false);
    });
  }

  bindMarkerPaging(data,type){
    var se = this;
    if(se.sortvalue && type != 'clickdooropen'){
      se.sortvalue = null;
      se.zone.run(()=>{
        $('.col-item-search-2').removeClass('cls-sort-filter');
      })
    }
    if(!se.sortvalue){
      se.zone.run(()=>{
        $('.col-item-search-2').removeClass('cls-sort-filter');
      })
    }
    se.zone.run(()=>{
      data.forEach(item => {
        if(item.workingHours.length >0){
          item.workingHoursDisplay = '';
          item.workingHours.forEach(element => {
            if(!item.workingHoursDisplay){
              item.workingHoursDisplay = element.name + ' | '+ element.timeFrom + '-'+ element.timeTo;
            }else{
              item.workingHoursDisplay += " , " + element.name + ' | '+ element.timeFrom + '-'+ element.timeTo;
            }
          });
          
        }

        if(!se.gf.checkExistsItemInArray(se.listSearchDisplay,item,'experiencesearch')){
          se.listSearchDisplay.push(item);
        }
      });
      se.listSearchDisplay.forEach(rest =>{
        se.calculateDistanceMarker(rest,'totalDistance', null);
        se.bindShortAdress(rest);
      })
      setTimeout(()=>{
        se.loaddatadone = true;
        se.listSearchDisplay.forEach(item => {
          se.addMarkersToMap(item);
        });
      },50)

      // setTimeout(()=>{
      //   if(se.sortvalue){
      //     se.zone.run(()=>{
      //       se.sortData(se.sortvalue);
      //     })
      //   }
      // },150)
      
      if(se._infiniteScroll){
        se._infiniteScroll.target.complete();
      }
    })
  }
  bindShortAdress(item){
    var se = this;
    if(item.address && item.address.indexOf(',') != -1){
      var arrAdress = item.address.split(',');
      if(arrAdress.length >= 1){
        let shortAdress = arrAdress[0] + ', ' + arrAdress[1];
        item.shortAdress = shortAdress;
      }
    }
  }
  /**
   * Sắp xếp vị trí marker theo tên column sort, item làm mốc
   * @sortColumn: tên cột dữ liệu sort
   * @itemDest: item lấy làm mốc để sort
   */
  sortMarkerByDistance(sortColumn, itemDest){
    var se = this;
    se.listSearch.forEach(rest =>{
      se.calculateDistanceMarker(rest,sortColumn, itemDest);
      se.bindShortAdress(rest);
    })

    setTimeout(()=>{
      if (se.listSearchDisplay && se.listSearchDisplay.length > 0) {
        se.zone.run(() => se.listSearch.sort(function (a, b) {
          let direction = -1;
            if(a[sortColumn] && b[sortColumn] && a[sortColumn]*1 < b[sortColumn]*1){
              return 1 * direction;
            }else{
              return -1 * direction;
            }
        }));
      }
      //Xóa luôn route vẽ trên bản đồ vì chỉ để tính distance
      if(se.routesHidden && se.routesHidden.length >0){
        se.routesHidden.forEach( (element :any) => {
          se.map.removeControl(element);
        });
      }
    },100)
  }
  /**
   * Tính khoảng cách giữa các điểm so với vị trí hiện tại
   * @rest: item cần sort
   * @sortColumn: tên cột dữ liệu sort
   * @itemDest: item lấy làm mốc để sort
   */
  calculateDistanceMarker(rest:any, sortColumn, itemDest){
    var se = this;
    if(!rest.latitude || !rest.longitude){
      rest[sortColumn] =0;
    }else{
      if(sortColumn == 'totalDistance'){
        if(se.deviceLocation.latitude && se.deviceLocation.longitude && !se.searchhotel.inputExperienceItem){
          let distancekm = (Math.round(L.latLng(se.deviceLocation.latitude, se.deviceLocation.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000);
          if(distancekm < 50){
            rest[sortColumn] = (Math.round(L.latLng(se.deviceLocation.latitude, se.deviceLocation.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
          }else{
            rest[sortColumn] = (Math.round(L.latLng(se.locationCoords.latitude, se.locationCoords.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
          }
        }else{
          rest[sortColumn] = (Math.round(L.latLng(se.locationCoords.latitude, se.locationCoords.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
        }
        
      }else if(sortColumn == 'totalDistanceNearBy' && itemDest){
        if(itemDest.id == rest.id){
          rest[sortColumn] = 9999999;
        }else{
          rest[sortColumn] = (Math.round(L.latLng(itemDest.latitude, itemDest.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
        }
      }
      // else if(sortColumn == 'totalDistanceNearBy' && itemDest){
      //   if(itemDest.id == rest.id){
      //     rest[sortColumn] = 9999999;
      //   }else{
      //     rest[sortColumn] = (Math.round(L.latLng(itemDest.latitude, itemDest.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
      //   }
      // }
    }
    
  }

  /**
   * Add marker vị trí hiện tại vào map
   */
  bindCurrentLocationMarker(){
    var se = this;
        var customMarkerIcon:any= {         
          url: './assets/img_musttry/ic_pinmylocation.svg',
          scaledSize: new google.maps.Size(44, 44)    
        }
        const position = new google.maps.LatLng(se.locationCoords.latitude,se.locationCoords.longitude);
        //const marker = new google.maps.Marker({ position, icon: customMarkerIcon, zIndex: 888 });
        var marker;
        if(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.type){
          marker = new google.maps.Marker({ position, icon: customMarkerIcon, zIndex: 888,label: { text: (se.searchhotel.inputExperienceItem.type == 1 || se.searchhotel.inputExperienceItem.type == 2) ? se.searchhotel.inputExperienceItem.name : se.searchhotel.inputExperienceItem.hotelName, fontSize: '12px',color: '#848385' }, });
        }else{
          marker = new google.maps.Marker({ position, icon: customMarkerIcon, zIndex: 888 });
        }
        marker.setMap(se.map);
  }

  /**
   * Add marker vị trí hiện tại vào map
   */
  bindGPSLocationMarker(){
    var se = this;
        var gpsMarker:any= {         
          url: './assets/img_musttry/ic_mylocation.svg',
          scaledSize: new google.maps.Size(44, 44)    
        }
        const position = new google.maps.LatLng(se.deviceLocation.latitude,se.deviceLocation.longitude);
        var marker;
        if(se.searchhotel.inputExperienceItem){
          marker = new google.maps.Marker({ position, icon: gpsMarker, zIndex: 888,label: { text: (se.searchhotel.inputExperienceItem.type == 1 || se.searchhotel.inputExperienceItem.type == 2)  ? se.searchhotel.inputExperienceItem.name : se.searchhotel.inputExperienceItem.hotelName, fontSize: '12px',color: '#848385' }, });
        }else{
          marker = new google.maps.Marker({ position, icon: gpsMarker, zIndex: 888 });
        }
        //const marker = new google.maps.Marker({ position, icon: gpsMarker, zIndex: 888,label: { text: 'A123' }, });
        marker.setMap(se.map);
  }

  markerClick(marker, rest, map, isslide){
    var se = this;
    if(isslide){
      se.slidehaschange= true;
      se.markerhaschange= false;
    }else{
      se.slidehaschange= false;
      se.markerhaschange= true;
    }

    // //Clear old marker 
    // se.removeMarkerById(marker.id);
    // //Create selected marker
    // var markerNew:any = se.createNewMarkerById(marker, rest);

    var position = new google.maps.LatLng(rest.latitude,rest.longitude);
    se.map.setCenter(position);

    
    if($('.popup-selected').length >0){
      $('.popup-selected').children()[0].style.borderTop = 'solid 6px #003c71';
      $('.popup-selected').children()[0].style.marginTop = '2px';
      $('.popup-selected').parent()[0].style.borderTop = 'solid 6px #ffffff';
      
    }
    $('.popup-selected').removeClass('popup-selected');
    
    $('#'+marker.id).addClass('popup-selected');
    //if($('#'+marker.id).children().length >0){
      $('#'+marker.id).children()[0]['style']['display'] = 'block';
      $('#'+marker.id).children()[0].style.borderTop = 'solid 6px #ffffff';
      $('#'+marker.id).children()[0].style.marginTop = '2px';
      $('#'+marker.id).parent()[0].style.borderTop = 'solid 6px #003c71';
   // }
    

    //Move slide theo marker được chọn
    var idx=-1;
    idx = se.listSearchDisplay.findIndex((m:any)=>{ return m.id == marker.id});
      if(idx != -1 && idx != null && se.markerhaschange){
        se.slider.slideTo(idx);
      }
  }
  /**
   * Thay icon marker được tap trên bản đồ thành icon marker selected
   * Todo: Clone marker được select
   * Tạo marker selected dựa trên marker clone, push vào mảng marker selected
   * Xóa marker cũ được select ở trên và add marker selected được tạo trên vào vị trí marker cũ
   * @param marker 
   * @param rest 
   */
  createNewMarkerById(marker, rest){
    var se  = this;
    var customMarkerIconNearest:any;
    
   
    if(se.curType){
      customMarkerIconNearest = {         
        url: se.getMarkerSelectedByTagId(se.curType),
        scaledSize: new google.maps.Size(30.7, 40),
        labelOrigin: new google.maps.Point(12, 48)
      }
    }else{
      customMarkerIconNearest = {         
        url: se.getMarkerSelectedByTags(marker.type ? marker.type.toString() : se.curType.toString()),
        scaledSize: new google.maps.Size(30.7, 40),
        labelOrigin: new google.maps.Point(12, 48)
      }
    }

    var optionSelected = { icon: customMarkerIconNearest, id: marker.id, type: marker.type, rest: rest};
    var position = new google.maps.LatLng(marker.position.lat(),marker.position.lng());
    se.map.setCenter(position);
    const markerNew = new google.maps.Marker({ position, title: rest.name,
      label: {
              text: rest.name,
              color: "#e52822",
              fontSize: "13px",
              fontWeight: "bold",
              letterSpacing: "0.16px"
            } , icon: customMarkerIconNearest, options: optionSelected, zIndex: 888 });
    markerNew.setMap(se.map);
    se.addInfoWindow(markerNew, rest);
    if(se.markersSelected != null && se.markersSelected.length >0){

      //Tạo marker mới theo marker cũ được selected
      var objMarkerSelected :any =se.markersSelected[0];
      const customMarkerIcon = {         
        url: se.getMarkerByItemTags(objMarkerSelected.type.toString()),
        scaledSize: new google.maps.Size(24, 24),
        labelOrigin: new google.maps.Point(12, 36)
      }
     
      var option = { icon: customMarkerIcon, id: objMarkerSelected.id, type: objMarkerSelected.type, rest: objMarkerSelected.rest};
      const position = new google.maps.LatLng(objMarkerSelected.position.lat(),objMarkerSelected.position.lng());
      var markerSelectedNew = new google.maps.Marker({position, title: objMarkerSelected.rest.name,
        label: {
                text: objMarkerSelected.rest.name,
                color: "#000000",
                fontSize: "10px",
                //fontWeight: "bold",
                letterSpacing: "0.12px"
              }, icon: customMarkerIcon, options: option, zIndex: 888});
      markerSelectedNew.setMap(se.map);
      se.markers.push(markerSelectedNew);
      se.addInfoWindow(markerSelectedNew, objMarkerSelected.rest);
      //markerSelectedNew.on('click',() => se.markerClick(markerSelectedNew,objMarkerSelected.options.rest.name ,se.map,false));
      //Xóa mảng marker đang được selected
      se.markersSelected.forEach( (element:any) => {
        element.setMap(null);
      });
      se.markersSelected = [];
      se.markersSelected.push(markerNew);
    }else{
      se.markersSelected.push(markerNew);
    }


    if(se.markers && se.markers.length>0){
      se.markers.forEach( (element:any) => {
        if (se.map.getZoom() > 14) {
          element.setLabel({
            text: element.title,
            color: "#000000",
            fontSize: "10px",
            letterSpacing: "0.16px"
            //fontWeight: "bold",
          });
        } else {
          element.setLabel(null);
        }
      });
    }

    if(se.markersSelected && se.markersSelected.length>0){
      se.markersSelected.forEach( (element:any) => {
        if (se.map.getZoom() > 14) {
          element.setLabel({
            text: element.title,
            color: "#e52822",
            fontSize: "13px",
            fontWeight: "bold",
            letterSpacing: "0.16px"
          });
        } else {
          element.setLabel(null);
        }
    });
  }

    se.map.addListener('zoom_changed', function() {
      if(se.markers && se.markers.length>0){
        se.markers.forEach( (element:any) => {
          if (se.map.getZoom() > 14) {
            element.setLabel({
              text: element.title,
              color: "#000000",
              fontSize: "10px",
              letterSpacing: "0.12px"
              //fontWeight: "bold",
            });
          } else {
            element.setLabel(null);
          }
        });
      }

      if(se.markersSelected && se.markersSelected.length>0){
        se.markersSelected.forEach( (element:any) => {
          if (se.map.getZoom() > 14) {
            element.setLabel({
              text: element.title,
              color: "#e52822",
              fontSize: "13px",
              fontWeight: "bold",
              letterSpacing: "0.16px"
            });
          } else {
            element.setLabel(null);
          }
      });
    }

    });
    return markerNew;
  }

  getImageByType(type){
    switch(type){
      case 1:
        return './assets/img_musttry/an_gi.svg';
        break;
      case 2:
        return './assets/img_musttry/xem_gi.svg';
        break;
      case 3:
        return './assets/img_musttry/choi_gi.svg';
        break;
      case 4:
        return './assets/img_musttry/o_dau.svg';
        break;
      case 5:
        return './assets/img_musttry/song_ao.svg';
        break;
      case 6:
        return './assets/img_musttry/phuong_tien.svg';
        break;
      default:
        return './assets/img_musttry/marker.svg';
        break;
    }
  }

  getImageByTagId(TagId, tags){
    switch(TagId){
      case 3:
        return './assets/img_musttry/an_gi.svg';
        break;
      case 6:
        return './assets/img_musttry/xem_gi.svg';
        break;
      case 7:
        return './assets/img_musttry/choi_gi.svg';
        break;
      case 4:
        return './assets/img_musttry/o_dau.svg';
        break;
      case 9:
        return './assets/img_musttry/song_ao.svg';
        break;
      case 8:
        return './assets/img_musttry/phuong_tien.svg';
        break;
      default:
        if(tags != null && tags.length >0){
          return this.getMarkerByItemTags(tags.toString());
        }else{
          return './assets/img_musttry/marker.svg';
        }
        break;
    }
  }
  
  getTagByType(type){
    switch(type){
      case 1:
        return 3;
        break;
      case 2:
        return 6;
        break;
      case 3:
        return 7;
        break;
      case 4:
        return 4;
        break;
      case 5:
        return 9;
        break;
      case 6:
        return 8;
        break;
    }
  }

  getTagByTypeName(){
    var se = this;
    if(se.searchhotel.ef_arrhoteltypenamecheck.length>0){
      se.searchhotel.ef_arrhoteltypenamecheck.forEach(element => {
        if(element == 'Ăn gì' && !se.gf.checkExistsItemInArray(se.searchhotel.ef_arrhoteltypecheck, 3, 'filtername')){
          se.searchhotel.ef_arrhoteltypecheck.push(3);
        }
        else if(element == 'Xem gì' && !se.gf.checkExistsItemInArray(se.searchhotel.ef_arrhoteltypecheck, 6, 'filtername')){
          se.searchhotel.ef_arrhoteltypecheck.push(6);
        }
        else if(element == 'Chơi gì' && !se.gf.checkExistsItemInArray(se.searchhotel.ef_arrhoteltypecheck, 7, 'filtername')){
          se.searchhotel.ef_arrhoteltypecheck.push(7);
        }
        else if(element == 'Ở đâu' && !se.gf.checkExistsItemInArray(se.searchhotel.ef_arrhoteltypecheck, 4, 'filtername')){
          se.searchhotel.ef_arrhoteltypecheck.push(4);
        }
        else if(element == 'Sống ảo' && !se.gf.checkExistsItemInArray(se.searchhotel.ef_arrhoteltypecheck, 9, 'filtername')){
          se.searchhotel.ef_arrhoteltypecheck.push(9);
        }
        else if(element == 'Di chuyển' && !se.gf.checkExistsItemInArray(se.searchhotel.ef_arrhoteltypecheck, 8, 'filtername')){
          se.searchhotel.ef_arrhoteltypecheck.push(8);
        }
      });
    }
  }

  /**
   * Hàm lấy icon marker được chọn/ địa điểm gần nhất
   */
  getMarkerByItemTags(tags){
    var se = this;
    if(tags&& tags.length >0){
      if(tags.indexOf(3) != -1)
      {
        return './assets/img_musttry/an_gi.svg';
      }
      if(tags.indexOf(6) != -1)
      {
        return './assets/img_musttry/xem_gi.svg';
      }
      if(tags.indexOf(7) != -1)
      {
        return './assets/img_musttry/choi_gi.svg';
      }
      if(tags.indexOf(4) != -1)
      {
        return './assets/img_musttry/o_dau.svg';
      }
      if(tags.indexOf(9) != -1)
      {
        return './assets/img_musttry/song_ao.svg';
      }
      if(tags.indexOf(8) != -1)
      {
        return './assets/img_musttry/phuong_tien.svg';
      }else{
        return './assets/img_musttry/marker.svg';
      }
    }
  }

  /**
   * Hàm lấy icon marker được chọn/ địa điểm gần nhất
   * @param TagId id tag theo từng địa điểm
   */
  getMarkerSelectedByTagId(TagId){
    switch(TagId){
      case 3:
        return './assets/img_musttry/ic_food_selected.svg';
        break;
      case 6:
        return './assets/img_musttry/ic_eye_selected.svg';
        break;
      case 7:
        return './assets/img_musttry/ic_celebrate_selected.svg';
        break;
      case 4:
        return './assets/img_musttry/ic_home_selected.svg';
        break;
      case 9:
        return './assets/img_musttry/ic_camera_selected.svg';
        break;
      case 8:
        return './assets/img_musttry/ic_airplane_selected.svg';
        break;
      default:
        return './assets/img_musttry/marker.svg';
        break;
    }
  }

  /**
   * Hàm lấy icon marker được chọn/ địa điểm gần nhất sau khi từ form lọc
   * @param TagId id tag theo từng địa điểm
   */
  getMarkerSelectedByTags(tags){
    if(tags&& tags.length >0){
      if(tags.indexOf(3) != -1)
      {
        return './assets/img_musttry/ic_food_selected.svg';
      }
      if(tags.indexOf(6) != -1)
      {
        return './assets/img_musttry/ic_eye_selected.svg';
      }
      if(tags.indexOf(7) != -1)
      {
        return './assets/img_musttry/ic_celebrate_selected.svg';
      }
      if(tags.indexOf(4) != -1)
      {
        return './assets/img_musttry/ic_home_selected.svg';
      }
      if(tags.indexOf(9) != -1)
      {
        return './assets/img_musttry/ic_camera_selected.svg';
      }
      if(tags.indexOf(8) != -1)
      {
        return './assets/img_musttry/ic_airplane_selected.svg';
      }
      else{
        return './assets/img_musttry/marker.svg';
      }
    }else{
      return './assets/img_musttry/marker.svg';
    }
  }

  hideMapElement(){
    var se = this;
    var el = $("#mapDiv");
    if(el && el.length >0){
      var elgmno = $("#mapDiv").querySelector('.gmnoprint');
      if(elgmno && elgmno.length >0){
        elgmno.attributes.style.value = elgmno.attributes.style.value + "; display: none";
      }

      var elplacecard = $("#mapDiv").querySelector('.place-card');
      if(elplacecard && elplacecard.length >0){
        elplacecard.attributes.style.value = elplacecard.attributes.style.value + "; display: none";
      }

      var ellogincontrol = $("#mapDiv").querySelector('.login-control');
      if(ellogincontrol && ellogincontrol.length >0){
        ellogincontrol.attributes.style.value = ellogincontrol.attributes.style.value + "; display: none";
      }

      var elgminset = $("#mapDiv").querySelector('.gm-inset');
      if(elgminset && elgminset.length >0){
        elgminset.attributes.style.value = elgminset.attributes.style.value + "; display: none";
      }
      
    }
  }

  addTextSearch(type){
    var se = this;
    if(type==1){
      se.textsearch = "Ăn gì";
    }
    if(type==2){
      se.textsearch = "Xem gì";
    }
    if(type==3){
      se.textsearch = "Chơi gì";
    }
    if(type==4){
      se.textsearch = "Ở đâu";
    }
    if(type==5){
      se.textsearch = "Sống ảo";
    }
    if(type==6){
      se.textsearch = "Di chuyển";
    }
    $('.input-search').addClass('searchbar-has-focus');
  }
  /**
   * Ẩn hiện div itemsearch/ listsearch khi chọn/xóa theo item
   */
  showHideItemSearch(show){
    if(show){
      $('.div-list-search-result').addClass('cls-show').removeClass('cls-hide');
      $('.div-item-search').removeClass('cls-show').addClass('cls-hide');
    }else{
      $('.div-item-search').addClass('cls-show').removeClass('cls-hide');
      $('.div-list-search-result').removeClass('cls-show').addClass('cls-hide');
    }
    
  }

  buildFilter(){
    var se = this, sfilter= '';
    if(se.searchhotel.ef_arrlocalcheck.length >0 ){
      sfilter += se.searchhotel.ef_arrlocalcheck.join(',');
    }

    if(se.searchhotel.ef_arrhoteltypecheck.length >0 ){
      if(sfilter && sfilter.length>0){
        sfilter += ','+ se.searchhotel.ef_arrhoteltypecheck.join(',');
      }else{
        sfilter += se.searchhotel.ef_arrhoteltypecheck.join(',');
      }
      
    }

    if(se.searchhotel.ef_arrstylecheck.length >0 ){
      if(sfilter && sfilter.length>0){
        sfilter += ','+ se.searchhotel.ef_arrstylecheck.join(',');
      }else{
        sfilter += se.searchhotel.ef_arrstylecheck.join(',');
      }
      
    }
  
    return sfilter;
  }
  /**
   * Sự kiện khi người dùng nhập vào ô text search
   */
  getItems(event){
    var se = this;
    se.loaddatadone=false;
    if(event.detail.value == "" || !se.searchhotel.inputExperienceItem){
      se.cancelInput();
    }
  }

  loadDataMap(data){
    var se = this;
    se.reCountFilter();
    if(se.searchhotel.ef_arrdistancecheck && se.searchhotel.ef_arrdistancecheck.length>0){
      data.forEach(element => {
        se.calculateDistanceMarker(element, 'totalDistance', null);
      });


      setTimeout(()=>{
        let d = se.getDistanceFilter();
        data = data.filter((item)=>{ return item.totalDistance <= d })

        if(data.length ==0){
          se.setBottomState();
          se.loaddatadone = true;
          se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
        }
      },50)
    }

    
    if(se.searchhotel.ef_arrhouropencheck && se.searchhotel.ef_arrhouropencheck.length>0){
      data = se.filterOpenHour(data);
    }

    if(data && data.length>0){
      se.zone.run(()=>{
        se.listSearch = data;
        se.listSearchOriginal = [];
        se.listSearchDisplay=[];
        se.loaddatadone = true;
        se.listSearchOriginal.push(...data);
        if(data && data[0] && data[0].regionId){
          se.regionId = data[0].regionId;
        }
       
      })
      //Nếu item search theo item place thì lấy theo vị trí place
      //Nếu search theo vùng thì lấy vị trí theo place đầu tiên của list place theo vùng
      

      if(se.searchhotel.inputExperienceItem.subRegionCode && se.searchhotel.inputExperienceItem.subRegionId){
        $.get('https://nominatim.openstreetmap.org/search?format=json&q='+se.searchhotel.inputExperienceItem.subRegionCode + ' ' + se.searchhotel.inputExperienceItem.regionCode, function(datasubregion){
            if(datasubregion && datasubregion.length>0){
              se.subRegionLocation.regioncode = se.searchhotel.inputExperienceItem.regionCode;
              if(!se.gf.checkExistsIndex(se.searchhotel.ef_arrsubregioncheck,se.searchhotel.inputExperienceItem.subRegionId)){
                se.searchhotel.ef_arrsubregioncheck.push(se.searchhotel.inputExperienceItem.subRegionId);
              }
              se.searchhotel.ef_arrsubregionnamecheck = se.searchhotel.inputExperienceItem.name;
              if(se.searchhotel.inputExperienceItem.subRegionCode == 'long-hai'){
                se.locationCoords.latitude = datasubregion[1].lat;
                se.locationCoords.longitude = datasubregion[1].lon;
              }else{
                se.locationCoords.latitude = datasubregion[0].lat;
                se.locationCoords.longitude = datasubregion[0].lon;
              }
              
              se.clearMarkerAndRouting();
              se.initMap();
              $('.div-float-item-search').removeClass('float-visible').addClass('float-disable');
              se.bindMarker(data,se.searchhotel.experiencesearchTagsId);
            }else{
              se.locationCoords.latitude = se.searchhotel.inputExperienceItem.latitude ? se.searchhotel.inputExperienceItem.latitude : data[0].latitude;
              se.locationCoords.longitude = se.searchhotel.inputExperienceItem.longitude ? se.searchhotel.inputExperienceItem.longitude: data[0].longitude;

              se.clearMarkerAndRouting();
              se.initMap();
              $('.div-float-item-search').removeClass('float-visible').addClass('float-disable');
              se.bindMarker(data,se.searchhotel.experiencesearchTagsId);
            }
        })
      }else{
        se.locationCoords.latitude = se.searchhotel.inputExperienceItem.latitude ? se.searchhotel.inputExperienceItem.latitude : data[0].latitude;
        se.locationCoords.longitude = se.searchhotel.inputExperienceItem.longitude ? se.searchhotel.inputExperienceItem.longitude: data[0].longitude;

        se.clearMarkerAndRouting();
        se.initMap();
        $('.div-float-item-search').removeClass('float-visible').addClass('float-disable');
        se.bindMarker(data,se.searchhotel.experiencesearchTagsId);
      }
  
      
    }
    else{
      se.loaddatadone = true;
      se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
    }
    se.curType = '';
    //scroll to Top
    //se.content.scrollToTop(100);
  }

  clickSearch(){
    this.searchhotel.clearFilterExperience = false;
    this.recent = this.searchhotel.ItemExperienceRegionRecent;
    this.searchhotel.inputExperienceRegionCode = null;
    this.searchhotel.inputExperienceText = null;
    this.searchhotel.inputExperienceItem = null;
    this.listSearchOriginal=[];
    this.listSearch=[];
    this.listSearchDisplay=[];
    this.dockedHeight = 0;
    this.textsearch='';
    this.searchhotel.ef_arrlocalcheck = [];
    this.searchhotel.ef_arrlocalnamecheck = [];
    this.searchhotel.ef_arrsubregioncheck = [];
    this.searchhotel.ef_arrsubregionnamecheck = [];
    this.searchhotel.deviceLocation = this.deviceLocation ? this.deviceLocation : this.locationCoords;
    //this.searchhotel.stringFilterName="";
    this.navCtrl.navigateForward('/searchexperienceregion');
  }

  /**
   * Nhấn xóa trên ô input/ xóa hết textsearch
   */
  cancelInput(){
    var se= this;
    se.itemclick = false;
    se.clearMarkerAndRouting();
    
  }
  /**
   * Xóa marker theo id
   */
  removeMarkerById(id){
    var se = this;
    if(se.markers && se.markers.length>0){
      se.markers.forEach( (element:any) => {
        if(element.id && element.id == id){
          element.setMap(null);
        }
      });
    }
 
  }
  
  clearMarkerAndRouting(){
    var se = this;
    if(se.map){
      if($('.popup-container').length >0){
        for(let i =0; i<$('.popup-container').length; i++){
          $('.popup-container')[i]['style']['display']= 'none';
          //$('.popup-container')[i].remove();
        }
      }

      if($('.popup-bubble').length >0){
        for(let j=0; j< $('.popup-bubble').length; j++){
          $('.popup-bubble')[j]['style']['display']= 'none';
        }
      }

      if($('.popup-bubble-anchor').length >0){
        for(let k =0; k<$('.popup-bubble-anchor').length; k++){
          $('.popup-bubble-anchor')[k]['style']['border-top']= '4px solid transparent';
        }
      }
    }
  }

  onScrollBlog(event){

  }
  /**
   * show popup lọc
   */
  async showFilter(){
    var se = this;
    se.loaddatadone=false;
    se.content.scrollToTop(50);
    if(se.actionSheet){
      se.actionSheet.dismiss();
    }
    
    se.curType='';
    se.searchhotel.stringFilterName = '';
    se.gf.setParams(se.regionId ? se.regionId : se.regionCode,'experienceFilter_regionId');
    se.gf.setParams(se.regionCode,'experienceFilter_regionCode');
    se.gf.setParams({ deviceLocation: se.deviceLocation, locationCoords: se.locationCoords, listData: se.listSearch}, 'experienceLocation');
    const modal: HTMLIonModalElement =
    await this.modalCtrl.create({
      component: ExperienceFilterPage
    });
    modal.present();

    modal.onDidDismiss().then((data: OverlayEventDetail) => {
      var strFilter = '';
      se.textsearch='';
      se.pageCount =0;
      se.totalPage =0;
      se.listSearchOriginal=[];
      se.listSearch=[];
      se.listSearchDisplay=[];
      let urlAPi='';
      se.filterHourOpen = 1;
      if (data.data || se.searchhotel.ef_arrdistancecheck.length >0) {
        se.zone.run(() => {
          strFilter = data.data.strFilter;
          se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionCodes='+se.regionCode+''+ (strFilter ? strFilter : '');
          urlAPi = se.url +'&paging.pageNumber='+se.pageCount+'&paging.pageSize='+se.pageSize;
            se.reLoadDataAfterFilter(urlAPi, strFilter, data.data.dataFilter);
            se.buildTextSearch();
            if(se.textsearch.length >0 && !(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.placeId)){
              se.textsearch += " (" + data.data.dataFilter.length + ")";
            }
            if(se.searchhotel.inputExperienceRegionName && se.textsearch.indexOf(se.searchhotel.inputExperienceRegionName) == -1){
              se.textsearch += ' | ' + se.searchhotel.inputExperienceRegionName;
            }
            
        })
      }else{
        if(se.searchhotel.clearFilterExperience){
          se.countfilter = 0;
          se.textsearch = "";
          se.cancelInput();
          se.listSearchOriginal=[];
          se.listSearch=[];
          se.listSearchDisplay=[];
          se.locationCoords.latitude = 10.7679735;
          se.locationCoords.longitude = 106.6934983;
          se.initEmptyMap();
        }else{
          strFilter += se.buildFilter();

          se.url = C.urls.baseUrl.urlMobile + '/api/Data/GetPlace?regionCodes='+se.regionCode+'&Tags='+(strFilter ? strFilter : '');
          urlAPi = se.url +'&paging.pageNumber=0&paging.pageSize='+se.pageSize;
          se.reLoadDataAfterFilter(urlAPi, '', null);
          se.buildTextSearch();
        }
      }
      
    
    })
  }
  buildTextSearch(){
    var se = this;
    // if(se.searchhotel.stringFilterName && se.searchhotel.stringFilterName.length >0){
    //   se.textsearch = se.searchhotel.stringFilterName;
    // }
    let sfilter='';
    se.textsearch = se.buildStringFilterName(sfilter);
    if(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.tagsJson && se.searchhotel.inputExperienceItem.tagsJson.length >0){
      let sname = se.searchhotel.inputExperienceItem.tagsJson[0].name;
      if(se.textsearch.indexOf(sname) == -1){
        se.searchhotel.ef_arrhoteltypenamecheck.push(sname);
        if(se.textsearch.length>0){
          se.textsearch+= ', ' + sname;
        }else{
          se.textsearch+= sname;
        }
      }
    }
    if(se.searchhotel.inputExperienceText && se.textsearch && se.textsearch.length>0){
      if(se.textsearch.indexOf(se.searchhotel.inputExperienceText) == -1){
        se.textsearch += ' | '+ se.searchhotel.inputExperienceText;
      }
    }else{
      if(se.textsearch.indexOf(se.searchhotel.inputExperienceText) == -1){
        se.textsearch += se.searchhotel.inputExperienceText ? se.searchhotel.inputExperienceText : '';
      }

    }

    
  }

  /**
   * Hàm load lại dữ liệu sau filter
   * @param url url gọi api
   * @param strFilter chuỗi filter
   */
  reLoadDataAfterFilter(url,strFilter, dataFilter){
    var se = this;
    se.gf.RequestApi('GET',url,{},{},'ExperienceSearch', 'reLoadDataAfterFilter').then((data:any)=>{
      se.loaddatadone = true;
      se.dockedHeight = 300;
      //dataFilter dữ liệu trả về sau khi lọc trên page filter
      if(dataFilter && dataFilter.length>0){
        //Lọc listdata theo list data đã filter
        let arr = dataFilter.map((e)=>{ return e.id});
        data.data = data.data.filter((item)=>{ return  arr.includes(item.id) });
      }else{
        data.data = [];
      }
        data.data.forEach(element => {
          se.calculateDistanceMarker(element, 'totalDistance', null);
        });
        if(se.searchhotel.ef_arrdistancecheck && se.searchhotel.ef_arrdistancecheck.length>0){
          setTimeout(()=>{
            let d = se.getDistanceFilter();
            data.data = data.data.filter((item)=>{ return item.totalDistance <= d })
            
          },50)
        }
        if(se.searchhotel.ef_arrhouropencheck && se.searchhotel.ef_arrhouropencheck.length>0){
            data.data = se.filterOpenHour(data.data);
        }
        if(data.data && data.data.length>0){

          //Thêm regionName nếu chưa có trên textsearch
          let rn = data.data[0].regionName;
          if(se.textsearch.indexOf(rn) == -1 && !se.searchhotel.inputExperienceRegionName){
              if(data.data[0].address){
                let arrAddress = data.data[0].address.split(',');
                let rn = arrAddress[arrAddress.length -2];
                if(se.textsearch.indexOf(rn) == -1 && !se.searchhotel.inputExperienceRegionName){
                  if(se.textsearch.length >0){
                    se.textsearch += ' | '+ rn.trimLeft();
                  }else{
                    se.textsearch += rn.trimLeft() + " (" +data.data.length+ ")";
                  }
                  
              }
            }
          }

            setTimeout(()=>{
              se.storage.get('auth_token').then(auth_token => {
                if (auth_token) {
                    var text = "Bearer " + auth_token;
                    let urlLike = C.urls.baseUrl.urlMobile + '/api/Data/GetPlaceUserLike';
                    se.gf.RequestApi('GET', urlLike, {authorization: text}, {}, 'ExperienceSearch','GetPlaceUserLike').then((datalike:any) =>{
                      if(datalike && datalike.length >0){
                        se.dataListLike = datalike;
                        data.data.forEach(element => {
                          element.liked = se.checkItemLiked(element.id) ? true: false;
                        });
                        se.executeReloadData(data.data, strFilter);
                      }else{
                        se.executeReloadData(data.data, strFilter);
                      }
                    })
                  }else{
                    se.executeReloadData(data.data, strFilter);
                  }
              })
          },150)
        }else{
          se.loaddatadone = true;
          se.listSearch = [];
          se.listSearchDisplay =[];
          se.clearMarkerAndRouting();
          se.initEmptyMap();
          se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
          se.reCountFilter();
        }
      // }else{
      //   se.loaddatadone = true;
      //     se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
      // }
      
    })
  }

  filterOpenHour(data){
    var se = this;
    return data.filter((el)=>{
      //let timeFilter = se.getTimeFilter();
      if(el.workingHours.length >1){
        let wk0 = el.workingHours[0];
        let wk1 = el.workingHours[1];
        if(wk0){
          if(wk0.name.indexOf('24/24') != -1){
            return true;
          }if(wk0.name.indexOf('đêm') != -1){
            let fromTimeFirst = wk0.timeFrom.replace(':','');
            let toTimeFirst = '2400';
            let fromTimeSecond = '0000';
            let toTimeSecond = wk0.timeTo.replace(':','');
            return (se.getTimeFilter(fromTimeFirst, toTimeFirst) || se.getTimeFilter(fromTimeSecond, toTimeSecond) );
          }
          else{
            let fromTime = wk0.timeFrom.replace(':','');
            let toTime = wk0.timeTo.replace(':','');
            return se.getTimeFilter(fromTime, toTime);
          }
        }

        if(wk1){
          if(wk1.name.indexOf('24/24') != -1){
            return true;
          }if(wk1.name.indexOf('đêm') != -1){
            let fromTimeFirst = wk1.timeFrom.replace(':','');
            let toTimeFirst = '2400';
            let fromTimeSecond = '0000';
            let toTimeSecond = wk1.timeTo.replace(':','');
            return (se.getTimeFilter(fromTimeFirst, toTimeFirst) || se.getTimeFilter(fromTimeSecond, toTimeSecond) );
          }
          else{
            let fromTime = wk1.timeFrom.replace(':','');
            let toTime = wk1.timeTo.replace(':','');
            return se.getTimeFilter(fromTime, toTime);
          }
        }
        
      }else{
        if(el.workingHours[0].name.indexOf('24/24') != -1){
          return true;
        }if(el.workingHours[0].name.indexOf('đêm') != -1){
          let fromTimeFirst = el.workingHours[0].timeFrom.replace(':','');
          let toTimeFirst = '2400';
          let fromTimeSecond = '0000';
          let toTimeSecond = el.workingHours[0].timeTo.replace(':','');
          return (se.getTimeFilter(fromTimeFirst, toTimeFirst) || se.getTimeFilter(fromTimeSecond, toTimeSecond) );
        }
        else{
          let fromTime = el.workingHours[0].timeFrom.replace(':','');
          let toTime = el.workingHours[0].timeTo.replace(':','');
          return se.getTimeFilter(fromTime, toTime);
        }
      }
      
    })
  }

  getTimeFilter(fromTime, toTime){
    var se = this;
    let minFromTime ='';
    let maxToTime='';
    let maxHour = Math.max(...se.searchhotel.ef_arrhouropencheck);
    let minHour = Math.min(...se.searchhotel.ef_arrhouropencheck);
    minFromTime = se.getMinFromTime(minHour);
    maxToTime = se.getMaxToTime(maxHour);

    return  (minFromTime >= fromTime && minFromTime <= toTime && maxToTime >= fromTime && maxToTime <= toTime) || (fromTime >= minFromTime && fromTime <= maxToTime && toTime >= minFromTime && toTime <= maxToTime || (fromTime >= minFromTime && fromTime <= maxToTime && toTime > maxToTime) ||(toTime >= minFromTime && toTime <= maxToTime) );
  }

  getMinFromTime(hour){
    if(hour == 1 || hour == 5){
      return '0500';
    }
    if(hour == 2){
      return '1000';
    }
    if(hour == 3){
      return '1200';
    }
    if(hour == 4){
      return '1700';
    }
    if(hour == 6){
      return '0001';
    }
  }

  getMaxToTime(hour){
    if(hour == 1){
      return '1200';
    }
    if(hour == 2){
      return '1400';
    }
    if(hour == 3 || hour == 5){
      return '2300';
    }
    if(hour == 4|| hour == 6){
      return '2400';
    }
  }

  executeReloadData(data,strFilter){
    var se = this;
    if(data && data.length>0){
      $('.div-float-item-search').removeClass('float-visible').addClass('float-disable');
      se.zone.run(()=>{
        se.totalPage = Math.round(data.length/5);
      })
      
      se.zone.run(()=>{
        se.loaddatadone = false;
        se.listSearchDisplay=[];
        se.listSearchOriginal=[];
        se.listSearch = data;
        se.listSearchOriginal = data;
        // data.forEach(element => {
        //   if(!se.gf.checkExistsItemInArray(se.listSearchOriginal, element,'experiencesearch')){
        //     se.listSearchOriginal.push(element);
        //   }
        // });
        //se.listSearchOriginal.push(...data);
        se.clearMarkerAndRouting();
        se.bindMarker(data,strFilter);
      })
    }else{
      se.clearMarkerAndRouting();
      se.setBottomState();
      se.loaddatadone = true;
      se.showWarning('Không có trải nghiệm theo điều kiện tìm kiếm của bạn. Xin vui lòng chọn bộ lọc khác.');
    }
    
    se.reCountFilter();
    //se.content.scrollToTop(200);
  }

  getDistanceFilter(){
    var se = this, distance = 0;
      if(se.searchhotel.ef_arrdistancecheck && se.searchhotel.ef_arrdistancecheck.length>0)
      {
        let d = Math.max(...se.searchhotel.ef_arrdistancecheck);
        distance = d == 1 ? 1 : ( d==4 ? d *5 : ((d-1) * 5) );
      }   
    return distance;
  }
  /**
   * Hàm đếm lại số filter
   * */
  reCountFilter(){
    var se = this;
    se.countfilter = 0;
    se.zone.run(()=>{
      if(se.searchhotel.ef_arrhoteltypecheck && se.searchhotel.ef_arrhoteltypecheck.length >0){
        se.countfilter += se.searchhotel.ef_arrhoteltypecheck.length;
      }
      if(se.searchhotel.ef_arrstylecheck && se.searchhotel.ef_arrstylecheck.length >0){
        se.countfilter += se.searchhotel.ef_arrstylecheck.length;
      }
      if(se.searchhotel.ef_arrlocalcheck && se.searchhotel.ef_arrlocalcheck.length >0){
        se.countfilter += se.searchhotel.ef_arrlocalcheck.length;
      }
      if(se.searchhotel.ef_arrhouropencheck && se.searchhotel.ef_arrhouropencheck.length >0){
        se.countfilter += se.searchhotel.ef_arrhouropencheck.length;
      }
      if(se.searchhotel.ef_arrdistancecheck && se.searchhotel.ef_arrdistancecheck.length >0){
        se.countfilter += se.searchhotel.ef_arrdistancecheck.length;
      }
      if(se.searchhotel.ef_arrsubregioncheck && se.searchhotel.ef_arrsubregioncheck.length >0){
        se.countfilter += se.searchhotel.ef_arrsubregioncheck.length;
      }
    })
  }

  async itemListSearchClick(item, listsearchdisplay){
    var se = this;
    if(se.actionSheet){
      se.actionSheet.dismiss();
    }
    se.gf.setParams(item,'experienceItem');
      let listdetail = (listsearchdisplay && listsearchdisplay.length >0) ? listsearchdisplay.map(e => ({ ... e })) : se.listSearchDisplay.map(e => ({ ... e }));
      se.gf.setParams(listdetail, 'listSearch_ExperienceDetail');
      //se.navCtrl.navigateForward('/experiencedetail');
      const modal: HTMLIonModalElement =
      await this.modalCtrl.create({
        component: ExperienceDetailPage,
        id: 'ExperienceDetail'
      });
      modal.present();
  
      modal.onDidDismiss().then((data: OverlayEventDetail) => {
       // if (se.sortvalue) {
          //bind lại popup
          if(!data.data){
            se.listSearchDisplay.forEach(element => {
              se.addMarkersToMap(element);
            });
            
            setTimeout(()=>{
              if(se.itemsearchfocus){
                var idx=-1;
                idx = se.listSearchDisplay.findIndex((m:any)=>{ return m.id == se.itemsearchfocus.id});
                  if(idx != -1 && idx != null){
                    se.slider.slideTo(idx);
                  }
                //se.slider.slideTo(se.listSearchDisplay.length - 1);
                se.itemsearchfocus = null;
              }
            },400)
            
            setTimeout(()=>{
              if(!se.itemsearchfocus){
                var idx=-1;
                idx = se.listSearchDisplay.findIndex((m:any)=>{ return m.id == item.id});
                  if(idx != -1 && idx != null){
                    se.slider.slideTo(idx);
                  }
              }
            },300)
          }
          
          
       // }
      })
    //},200)
    
  }

  searchAndClickMarker(item){
    var se = this;
    se.markerhaschange = false;
    se.slidehaschange= true;
    if(se.markers && se.markers.length >0){
      se.markers.forEach( (element:any) => {
        if(element.id == item.id){
          se.markerClick(element, element.rest, se.map, true);
        }
      });
    }
  }
  /**
   * Sắp xếp theo lượt like nếu có lên trên; ko có like thì sắp xếp theo tên
   */
  async clickSort(event){
    var se = this;
      se.sortData(event.detail.value);
      //sort luôn list all data để không bị giật khi loadpaging
      //se.sortAllData(event.detail.value)
      se.sortvalue = event.detail.value;
  }

  sortData(sortValue){
    var se = this;
    if (se.listSearchDisplay && se.listSearchDisplay.length > 0) {
      se.sort = se.sort*-1;
      se.zone.run(() => se.listSearchDisplay.sort(function (a, b) {
        let direction = -1;
          if(sortValue == 2){
            if(!a['totalDistance']){
              return 1 * direction;
            }else if(!b['totalDistance']){
              return -1 * direction;
            }
            else{
              let a1 = a['totalDistance'].toString().replace('.','')*1;
              let b1 = b['totalDistance'].toString().replace('.','')*1;
              if (a1 < b1) {
                return 1 * direction;
              }
              else{
                return -1 * direction;
              }
            }
            
          }
          else if(sortValue == 3){
            let direction =1;
            if (a['totalLike'] < b['totalLike']) {
              return 1 * direction;
            }
            else{
              return -1 * direction;
            }
          }else if(sortValue == 1){
            let a1='',b1='';
            a1 = a['name'];
            b1 = b['name'];

            a1 = se.convertFontVNI(a1);
            b1 = se.convertFontVNI(b1);

            if (a1 < b1) {
              return 1 * direction;
            }
            else if (a1 > b1) {
              return -1 * direction;
            }
          }
      }));

      setTimeout(()=>{
        se.listSearchDisplay.forEach(element => {
          se.addMarkersToMap(element);
        });
      },100)
    }
  }

  sortAllData(sortValue){
    var se = this;
    if (se.listSearch && se.listSearch.length > 0) {
      se.sort = se.sort*-1;
      se.zone.run(() => se.listSearch.sort(function (a, b) {
        let direction = -1;
          if(sortValue == 2){
            if(!a['totalDistance']){
              return 1 * direction;
            }else if(!b['totalDistance']){
              return -1 * direction;
            }
            else{
              let a1 = a['totalDistance'].toString().replace('.','')*1;
              let b1 = b['totalDistance'].toString().replace('.','')*1;
              if (a1 < b1) {
                return 1 * direction;
              }
              else{
                return -1 * direction;
              }
            }
            
          }
          else if(sortValue == 3){
            let direction =1;
            if (a['totalLike'] < b['totalLike']) {
              return 1 * direction;
            }
            else{
              return -1 * direction;
            }
          }else if(sortValue == 1){
            let a1='',b1='';
            a1 = a['name'];
            b1 = b['name'];

            a1 = se.convertFontVNI(a1);
            b1 = se.convertFontVNI(b1);

            if (a1 < b1) {
              return 1 * direction;
            }
            else if (a1 > b1) {
              return -1 * direction;
            }
          }
      }));
    }
  }
  /**
   * Chuyển ký tự font VNi vd: â - a ...
   */
  convertFontVNI(obj){
    if(obj.indexOf('đ') != -1 || obj.indexOf('Đ') != -1){
      obj = obj.replace('đ','d').replace('Đ','D');
    }
    if(obj.indexOf('ă') != -1 || obj.indexOf('Ă') != -1){
      obj = obj.replace('ă','a').replace('Ă','A');
    }
    if(obj.indexOf('â') != -1 || obj.indexOf('Â') != -1){
      obj = obj.replace('â','a').replace('Â','Â');
    }
    if(obj.indexOf('á') != -1 || obj.indexOf('Á') != -1){
      obj = obj.replace('á','a').replace('Á','A');
    }
    if(obj.indexOf('à') != -1 || obj.indexOf('À') != -1){
      obj = obj.replace('à','a').replace('À','A');
    }
    
    if(obj.indexOf('ê') != -1 || obj.indexOf('Ê') != -1){
      obj = obj.replace('ê','e').replace('Ê','Ê');
    }
    if(obj.indexOf('é') != -1 || obj.indexOf('É') != -1){
      obj = obj.replace('é','e').replace('É','E');
    }
    if(obj.indexOf('è') != -1 || obj.indexOf('È') != -1){
      obj = obj.replace('è','e').replace('È','E');
    }
    if(obj.indexOf('ẻ') != -1 || obj.indexOf('Ẻ') != -1){
      obj = obj.replace('ẻ','e').replace('Ẻ','E');
    }

    if(obj.indexOf('ô') != -1 || obj.indexOf('Ô') != -1){
      obj = obj.replace('ô','o').replace('Ô','O');
    }
    if(obj.indexOf('ồ') != -1 || obj.indexOf('Ồ') != -1){
      obj = obj.replace('ồ','o').replace('Ồ','O');
    }
    if(obj.indexOf('ố') != -1 || obj.indexOf('Ố') != -1){
      obj = obj.replace('ố','o').replace('Ố','O');
    }

    if(obj.indexOf('ú') != -1 || obj.indexOf('Ú') != -1){
      obj = obj.replace('ú','u').replace('Ú','U');
    }
    if(obj.indexOf('ù') != -1 || obj.indexOf('Ù') != -1){
      obj = obj.replace('ù','u').replace('Ù','U');
    }
    if(obj.indexOf('ủ') != -1 || obj.indexOf('Ủ') != -1){
      obj = obj.replace('ủ','u').replace('Ủ','U');
    }
    if(obj.indexOf('ũ') != -1 || obj.indexOf('Ũ') != -1){
      obj = obj.replace('ũ','u').replace('Ũ','U');
    }

    if(obj.indexOf('í') != -1 || obj.indexOf('Í') != -1){
      obj = obj.replace('í','i').replace('Í','I');
    }
    if(obj.indexOf('ì') != -1 || obj.indexOf('Ì') != -1){
      obj = obj.replace('ì','i').replace('Ì','I');
    }
    if(obj.indexOf('ỉ') != -1 || obj.indexOf('Ỉ') != -1){
      obj = obj.replace('ỉ','i').replace('Ỉ','I');
    }
    if(obj.indexOf('ĩ') != -1 || obj.indexOf('Ĩ') != -1){
      obj = obj.replace('ĩ','i').replace('Ĩ','I');
    }

    return obj;
  }
  /**
   * Lọc theo giờ mở cửa
   */
  clickDoorOpen(){
    var se = this;
    if(se.listSearchDisplay && se.listSearchDisplay.length >0){
      //Lọc lại list marker trên map 
      if(se.markers && se.markers.length >0){
        se.markersOriginal = se.markers;
      }
      se.filterHourOpen = se.filterHourOpen*-1;
      if(se.filterHourOpen == -1){
        se.zone.run(()=>{
          var curDate = new Date();
          var currentTime:any = moment(curDate).format("HHmm");
          //var currentTime=2100;
          se.listSearchDisplay = se.listSearchDisplay.filter((el)=>{
            return se.filterItemDoorOpen(el, currentTime);
          })
          se.listSearch = se.listSearch.filter((el1)=>{
            return se.filterItemDoorOpen(el1, currentTime);
          })
          se.clearMarkerAndRouting();
          se.bindMarkerPaging(se.listSearchDisplay,'clickdooropen');
        })
      }else{
        se.zone.run(()=>{
          //se.listSearchDisplay = [];
          se.listSearch = se.listSearchOriginal;
          se.clearMarkerAndRouting();
          se.bindMarker(se.listSearch,'clickdooropen');
        })
      }
      
    }else{
      se.filterHourOpen = se.filterHourOpen*-1;
      se.zone.run(()=>{
        se.listSearchDisplay = [];
        se.listSearch = se.listSearchOriginal;
        se.clearMarkerAndRouting();
        se.bindMarker(se.listSearch,se.curType);
      })
    }
  }

  filterItemDoorOpen(el, currentTime){
    if(el.workingHours.length >1){
      let wk0 = el.workingHours[0];
      let wk1 = el.workingHours[1];
      if(wk0){
        if(wk0.name.indexOf('24/24') != -1){
          return true;
        }if(wk0.name.indexOf('đêm') != -1){
          let fromTimeFirst:any = wk0.timeFrom.replace(':','');
          let toTimeFirst:any = '2400';
          let fromTimeSecond:any = '0000';
          let toTimeSecond:any = wk0.timeTo.replace(':','');
          return ( (currentTime*1 >= fromTimeFirst*1 && currentTime*1 <= toTimeFirst*1) || (currentTime*1 >= fromTimeSecond*1 && currentTime*1 <= toTimeSecond*1) );
        }
        else{
          let fromTime = wk0.timeFrom.replace(':','');
          let toTime = wk0.timeTo.replace(':','');
          return (currentTime*1 >= fromTime*1 && currentTime*1 <= toTime*1);
        }
      }

      if(wk1){
        if(wk1.name.indexOf('24/24') != -1){
          return true;
        }if(wk1.name.indexOf('đêm') != -1){
          let fromTimeFirst:any = wk1.timeFrom.replace(':','');
          let toTimeFirst:any = '2400';
          let fromTimeSecond:any = '0000';
          let toTimeSecond:any = wk1.timeTo.replace(':','');
          return ( (currentTime*1 >= fromTimeFirst*1 && currentTime*1 <= toTimeFirst*1) || (currentTime*1 >= fromTimeSecond*1 && currentTime*1 <= toTimeSecond*1) );
        }
        else{
          let fromTime = wk1.timeFrom.replace(':','');
          let toTime = wk1.timeTo.replace(':','');
          return (currentTime*1 >= fromTime*1 && currentTime*1 <= toTime*1);
        }
      }
      
    }else{
      if(el.workingHours[0].name.indexOf('24/24') != -1){
        return true;
      }if(el.workingHours[0].name.indexOf('đêm') != -1){
        let fromTimeFirst:any = el.workingHours[0].timeFrom.replace(':','');
        let toTimeFirst:any = '2400';
        let fromTimeSecond:any = '0000';
        let toTimeSecond:any = el.workingHours[0].timeTo.replace(':','');
        return ( (currentTime*1 >= fromTimeFirst*1 && currentTime*1 <= toTimeFirst*1) || (currentTime*1 >= fromTimeSecond*1 && currentTime*1 <= toTimeSecond*1) );
      }
      else{
        let fromTime = el.workingHours[0].timeFrom.replace(':','');
        let toTime = el.workingHours[0].timeTo.replace(':','');
        return (currentTime*1 >= fromTime*1 && currentTime*1 <= toTime*1);
      }
    }
  }

  expandMap(){
    var se = this;
    se.animateMap(true);
    se.showHideItemSearch(false);
  }

  //Check if application having GPS access permission  
  checkGPSPermission() {
    this.androidPermissions.checkPermission(this.androidPermissions.PERMISSION.ACCESS_COARSE_LOCATION).then(
      result => {
        if (result.hasPermission) {

          //If having permission show 'Turn On GPS' dialogue
          this.askToTurnOnGPS();
        } else {

          //If not having permission ask for permission
          this.requestGPSPermission();
        }
      },
      err => {
        alert(err);
      }
    );
  }

  requestGPSPermission() {
    this.locationAccuracy.canRequest().then((canRequest: boolean) => {
      if (canRequest) {
        this.getLocationCoordinates();
      } else {
        //Show 'GPS Permission Request' dialogue
        this.androidPermissions.requestPermission(this.androidPermissions.PERMISSION.ACCESS_COARSE_LOCATION)
          .then(
            () => {
              // call method to turn on GPS
              this.getLocationCoordinates();
            },
            error => {
              //Show alert if user click on 'No Thanks'
              //alert('requestPermission Error requesting location permissions ' + error)
              this.showWarning('Hãy bật định vị để tận hưởng trải nghiệm được tốt nhất.')
            }
          );
      }
    });
  }


  askToTurnOnGPS() {
    this.locationAccuracy.request(this.locationAccuracy.REQUEST_PRIORITY_HIGH_ACCURACY).then(
      () => {
        // When GPS Turned ON call method to get Accurate location coordinates
        this.getLocationCoordinates()
      },
      error => { this.requestGPS = false; }
    );
   
  }

  getLocationCoordinates() {
    this.requestGPS = true;
    this.geolocation.getCurrentPosition().then((resp) => {
      this.locationCoords.latitude = resp.coords.latitude;
      this.locationCoords.longitude = resp.coords.longitude;
      this.locationCoords.accuracy = resp.coords.accuracy;
      this.locationCoords.timestamp = resp.timestamp;

      this.deviceLocation.latitude = resp.coords.latitude;
      this.deviceLocation.longitude = resp.coords.longitude;

      this.initMap();

      //if(!this.regionCode && this.listSearchDisplay.length == 0){
        this.getCityNameByLatLng(this.locationCoords.latitude,this.locationCoords.longitude);
      //}

      //this.getGeoencoder(this.locationCoords.latitude,this.locationCoords.longitude )

    }).catch((error) => {
      // alert('Xin vui lòng mở dịch vụ định vị để tiếp tục sử dụng tính năng này.');
      // setTimeout(()=>{
      //   this.navCtrl.back();
      // },2000)
      //this.showWarning('Xin vui lòng mở dịch vụ định vị để tiếp tục sử dụng tính năng này.')
      this.loaddatadone = true;
      this.requestGPS = false;
      this.locationCoords.latitude = 10.7679735;
      this.locationCoords.longitude = 106.6934983;
      this.initEmptyMap();
    })
  }

  getCityNameByLatLng(lat, lng) {
    var se = this;
    
    let options: NativeGeocoderOptions = {
      useLocale: true,
      maxResults: 5
    };

    this.nativeGeocoder.reverseGeocode(lat, lng, options)
    .then(
      (result: NativeGeocoderResult[]) => {
        se.content.scrollToTop(50);
        var cityName = result[0].administrativeArea;
        se.searchhotel.inputExperienceRegionName = cityName;
        se.regionCode= se.convertFontVNI(cityName).replace(/ /g,'-');
        if(se.regionCode){
          if(se.regionCode == 'Quang-Nam'){
            se.regionCode = 'hoi-an';
          }
          if(se.regionCode == 'Ho-Chi-Minh' || se.regionCode == 'Thanh-Pho-Ho-Chi-Minh' || se.regionCode == 'Ho-Chi-Minh-City'){
            se.regionCode = 'ho-chi-minh';
          }
          if(se.regionCode == 'Lam-Dong'){
            se.regionCode = 'da-lat';
          }
          se.deviceLocation.regioncode = se.regionCode;
          se.getListSuggestByRegionCode(se.regionCode,null);
          se.textsearch ='';
          se.getTagByTypeName();
          se.buildTextSearch();
          // if(se.searchhotel.stringFilterName && se.searchhotel.stringFilterName.length >0){
          //   se.textsearch += se.searchhotel.stringFilterName;
          // }
          se.textsearch += ' | ' +cityName;

          //se.content.scrollToTop(100);
        }
      }
    )
    .catch((error: any) => 
    {
      $.get('https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat='+lat+'&lon='+lng, function(data){
        if(data){
        se.content.scrollToTop(50);
        var cityName = data.address.state;
        se.searchhotel.inputExperienceRegionName = cityName;
        se.regionCode= se.convertFontVNI(cityName).replace(/ /g,'-');
          if(se.regionCode){
            if(se.regionCode == 'Quang-Nam'){
              se.regionCode = 'hoi-an';
            }
            if(se.regionCode == 'Ho-Chi-Minh' || se.regionCode == 'Thanh-Pho-Ho-Chi-Minh' || se.regionCode == 'Ho-Chi-Minh-City'){
              se.regionCode = 'ho-chi-minh';
            }
            if(se.regionCode == 'Lam-Dong'){
              se.regionCode = 'da-lat';
            }
            se.deviceLocation.regioncode = se.regionCode;
            se.getListSuggestByRegionCode(se.regionCode,null);
            se.textsearch ='';
            se.getTagByTypeName();
            se.buildTextSearch();
            se.textsearch += ' | ' + data.address.state;
            se.searchhotel.inputExperienceRegionName = data.address.state;
          }
        }
      })
      
    });
    
  }

  likePlace(item){
    var se = this;
    se.storage.get('auth_token').then(auth_token => {
        if (auth_token) {
            se.bindPlaceLikeLocal(item, true, se.listSearch);
            se.bindPlaceLikeLocal(item, true, se.listSearchOriginal);
            var text = "Bearer " + auth_token;
            var header ={ authorization: text};
            var body = item.id;
            let urlLikePlace = C.urls.baseUrl.urlMobile + '/api/Data/LikePlace';
            se.gf.RequestApi('POST',urlLikePlace,header,body,'ExperienceSearch', 'likePlace').then((data:any)=>{
              
            })
        }else{
          se.showConfirmLogin("Bạn cần đăng nhập để sử dụng chức năng này.");
        }
      })
  }

  unlikePlace(item){
    var se = this;
    se.storage.get('auth_token').then(auth_token => {
        if (auth_token) {
            se.bindPlaceLikeLocal(item, false, se.listSearch);
            se.bindPlaceLikeLocal(item, false, se.listSearchOriginal);
            var text = "Bearer " + auth_token;
            var header = { authorization: text};
            var body = item.id;
            let urlLikePlace = C.urls.baseUrl.urlMobile + '/api/Data/UnLikePlace';
            se.gf.RequestApi('POST',urlLikePlace,header,body,'ExperienceSearch', 'unlikePlace').then((data:any)=>{
              
            })
        }else{
          se.showConfirmLogin("Bạn cần đăng nhập để sử dụng chức năng này.");
        }
      })
  }

  bindPlaceLikeLocal(item, islike, listItem){
    var se = this;
    if(listItem && listItem.length>0){
      se.zone.run(()=>{
        listItem.forEach(element => {
          if(islike){
            if(element.id == item.id){
              element.liked = true;
            }
          }else{
            if(element.id == item.id){
              element.liked = false;
            }
          }
        });
      })
    }
  }

  sharePlace(item){
    this.socialSharing.share(null, null, null, item.shareUrl).then(() => {
      // Success!
    }).catch(() => {
      // Error!
    });
  }

  checkItemLiked(id) {
    var co = 0;
    if (id) {
      for (let i = 0; i < this.dataListLike.length; i++) {
        if (this.dataListLike.indexOf(id) != -1) {
          co = 1;
          break;
        }
      }
    }

    return co;
  }

  public async showConfirmLogin(msg){
    let alert = await this.alertCtrl.create({
      backdropDismiss: false,
      message: msg,
      cssClass: 'alert-session-confirm experience-search-confirm',
      buttons: [
      {
        text: 'Để sau',
        handler: () => {
          this.storage.remove('auth_token');
          this.storage.remove('email');
          this.storage.remove('username');
          this.storage.remove('jti');
          this.storage.remove('userInfoData');
          this.storage.remove('userRewardData');
          this.storage.remove('point');
          this.storage.remove('blogtripdefault');
          this.zone.run(()=>{
            this.username= "";
          })
          alert.dismiss();
        }
      },
      {
        text: 'Đăng nhập',
        role: 'OK',
        handler: () => {
          this.storage.remove('auth_token');
          this.storage.remove('email');
          this.storage.remove('username');
          this.storage.remove('jti');
          this.storage.remove('userInfoData');
          this.storage.remove('userRewardData');
          this.storage.remove('point');
          this.storage.remove('blogtripdefault');
          this.zone.run(()=>{
            this.username= "";
          })
          this.navCtrl.navigateForward('/login');
        }
      }
    ]
    });
    alert.present();
    alert.onDidDismiss().then((data)=>{
    })
  }

  slidechange(){
    var se = this;
    se.markerhaschange = false;
    se.slidehaschange= true;
    se.slider.getActiveIndex().then((currentIndex)=>{
      let currentItemSelect = se.listSearchDisplay[currentIndex];
      if(currentItemSelect){
        se.markerClick(currentItemSelect,currentItemSelect,se.map, true);
      }
    });
  }

  scrollFunction(ev){
    var se = this;
    if(ev.detail.scrollTop >= 4 ){
      $('.div-float-item-search').removeClass('float-visible').addClass('float-disable');
    }else{
      $('.div-float-item-search').removeClass('float-disable').addClass('float-visible');
    }
    
    //console.log(ev.detail.scrollTop)
    //console.log(ev.path[1].clientHeight)
	  //let dh = ev.detail.event.target.clientHeight - ev.detail.scrollTop;
    let dh = ev.path[1].clientHeight - ev.detail.scrollTop;
    //if(ev.detail.scrollTop >= 568 ){
    if(dh <= 150 ){
      $('.float-search-white-bar').removeClass('float-disable').addClass('float-visible');
      $('.float-search-top').removeClass('float-disable').addClass('float-visible');
      $('.float-search').removeClass('float-visible').addClass('float-disable');
      //$('.item-filter').removeClass('cls-show').addClass('cls-hide');
    }else{
      $('.float-search-white-bar').removeClass('float-visible').addClass('float-disable');
      $('.float-search-top').removeClass('float-visible').addClass('float-disable');
      $('.float-search').removeClass('float-disable').addClass('float-visible');
      //$('.item-filter').removeClass('cls-hide').addClass('cls-show');
    }
  }

  doInfinite(infiniteScroll){
    var se = this;
    if(se.loaddatadone){
      se.zone.run(() => {
        se.pageCount = se.pageCount + 1;
        se._infiniteScroll = infiniteScroll;
        se.loadDataInfinite();
    })
    }else{
      if(se._infiniteScroll){
        se._infiniteScroll.target.complete();
      }
    }
    
  }

  loadDataInfinite(){
    var se = this,tags= '';
      se.totalPage = Math.round(se.listSearch.length /5);
      let count = se.listSearchDisplay.length;
      if(count >= se.listSearch.length){
        return;
      }
      let page = count + 5;
      if(page > se.listSearch.length)
      {
        page = se.listSearch.length;
        if(se._infiniteScroll){
          se._infiniteScroll.target.complete();
        }
      }
      var listdatapaging = [];
      for(let i = count; i < page; i ++){
        //if(!se.gf.checkExistsItemInArray(se.listSearchDisplay,se.listSearch[i], 'experiencesearch' )){
          //se.listSearchDisplay.push(se.listSearch[i]);
          listdatapaging.push(se.listSearch[i]);
        //}
      }
      se.loadDataPaging(listdatapaging);
  }

  loadDataPaging(data){
    var se = this;
      se.bindMarkerPaging(data,se.searchhotel.experiencesearchTagsId);
  }

  disableDashScroll(){
    var se = this;
    se.zone.run(()=>{
      se.dashScrollDisabled = true;
    })
  }
  enableDashScroll(){
    var se = this;
    se.zone.run(()=>{
      se.dashScrollDisabled = false;
    })
  }

  async showWarning(msg){
    var se = this;
    let toast = await se.toastCtrl.create({
      message: msg,
      duration: 3000,
      position: 'top'
    });

    toast.present();
  }

  createPopupClass() {
    /**
     * A customized popup on the map.
     * @param {!google.maps.LatLng} position
     * @param {!Element} content The bubble div.
     * @constructor
     * @extends {google.maps.OverlayView}
     */
    function Popup(position, content) {
      this.position = position;
  
      if(!content){
        return;
      }
      content.classList.add('popup-bubble');
  
      // This zero-height div is positioned at the bottom of the bubble.
      var bubbleAnchor = document.createElement('div');
      bubbleAnchor.classList.add('popup-bubble-anchor');

      var bubbleAnchorSub = document.createElement('div');
      bubbleAnchorSub.classList.add('popup-bubble-anchor-sub');
      bubbleAnchorSub.style.borderLeft= '4px solid transparent';
      bubbleAnchorSub.style.borderRight='4px solid transparent';
      bubbleAnchorSub.style.borderTop= '6px solid #003c71';
      bubbleAnchorSub.style.width='0';
      bubbleAnchorSub.style.height='0';
      bubbleAnchorSub.style.marginTop='2px';
      bubbleAnchorSub.style.marginLeft='50.1%';
      //bubbleAnchorSub.style.display='none';

      //bubbleAnchor.appendChild(bubbleAnchorSub);

      bubbleAnchor.appendChild(content);
      $(content).children().remove();
      content.appendChild(bubbleAnchorSub);
      bubbleAnchor.style.borderLeft= '4px solid transparent';
      bubbleAnchor.style.borderRight='4px solid transparent';
      bubbleAnchor.style.borderTop= '6px solid #ffffff';
      bubbleAnchor.style.width='0';
      bubbleAnchor.style.height='0';

      //var popupBubbleAnchor = document.getElementsByClassName('popup-bubble-anchor');
  
      // This zero-height div is positioned at the bottom of the tip.
      this.containerDiv = document.createElement('div');
      this.containerDiv.classList.add('popup-container');
      this.containerDiv.appendChild(bubbleAnchor);
  
      // Optionally stop clicks, etc., from bubbling up to the map.
      google.maps.OverlayView.preventMapHitsAndGesturesFrom(this.containerDiv);
    }
    
    // ES5 magic to extend google.maps.OverlayView.
    Popup.prototype = Object.create(google.maps.OverlayView.prototype);
  
    /** Called when the popup is added to the map. */
    Popup.prototype.onAdd = function() {
      if(this.containerDiv){
        this.getPanes().floatPane.appendChild(this.containerDiv);
      }
    };
  
    /** Called when the popup is removed from the map. */
    Popup.prototype.onRemove = function() {
      if (this.containerDiv && this.containerDiv.parentElement) {
        this.containerDiv.parentElement.removeChild(this.containerDiv);
      }
    };
    // var overlay = new google.maps.OverlayView();
    // overlay.draw = function() {};
    // overlay.setMap(this.map);
    /** Called each frame when the popup needs to draw itself. */
    Popup.prototype.draw = function() {
      var divPosition = this.getProjection().fromLatLngToDivPixel(this.position);
  
      // Hide the popup when it is far out of view.
      var display = 'block' ;
          // Math.abs(divPosition.x) < 4000000 && Math.abs(divPosition.y) < 4000000 ?
          // 'block' :
          // 'none';
      if(this.containerDiv){
        if (display === 'block') {
          this.containerDiv.style.left = divPosition.x + 'px';
          this.containerDiv.style.top = divPosition.y + 'px';
          this.containerDiv.style.position = 'absolute';
          this.containerDiv.style.width = '5px';
        }
        if (this.containerDiv.style.display !== display) {
          this.containerDiv.style.display = display;
        }
      }
      
    };
  
    return Popup;
  }
  
  changeState(){
    var se = this;
    if(se.drawerState == DrawerState.Docked){
      se.drawerState = DrawerState.Top;
      $('.content-container').removeClass('cls-state-docked').addClass('cls-state-top');
    }
    else if(se.drawerState == DrawerState.Top){
      se.drawerState = DrawerState.Bottom;
      $('.content-container').removeClass('cls-state-top').addClass('cls-state-bottom');
    }
    else if(se.drawerState == DrawerState.Bottom){
      se.drawerState = DrawerState.Docked;
      $('.content-container').removeClass('cls-state-bottom').addClass('cls-state-docked');
    }
    
  }

  setBottomState(){
    var se = this;
    se.drawerState = DrawerState.Bottom;
    $('.content-container').removeClass('cls-state-top').removeClass('cls-state-docked').addClass('cls-state-bottom');
  }

  setDockState(){
    var se = this;
    se.drawerState = DrawerState.Docked;
    $('.content-container').removeClass('cls-state-bottom').removeClass('cls-state-top').addClass('cls-state-docked');
  }

  bindHourOpenAndAdressAndDistance(item){
    var se = this;
    if(item.workingHours && item.workingHours.length >0){
      item.workingHoursDisplay = '';
      //item.workingHoursDisplay = item.workingHours[0].name + ' | '+ item.workingHours[0].timeFrom + '-'+ item.workingHours[0].timeTo;
      item.workingHours.forEach(element => {
        if(!item.workingHoursDisplay){
          item.workingHoursDisplay = element.name + ' | '+ element.timeFrom + '-'+ element.timeTo;
        }else{
          item.workingHoursDisplay += " , " + element.name + ' | '+ element.timeFrom + '-'+ element.timeTo;
        }
      });
    }
    se.bindShortAdress(item);
    se.calculateDistanceMarker(item,'totalDistance', null);
    if(!se.gf.checkExistsItemInArray(se.listSearchDisplay, item, 'experiencesearch')){
      se.listSearchDisplay.push(item);
    }
    
    se.itemsearchfocus = item;
    
    }
 
    setCurrentMarkerSelected(marker){
      var se = this;
      var position = new google.maps.LatLng(marker.latitude,marker.longitude);
      se.map.setCenter(position);

      
      if($('.popup-selected').length >0 && $('.popup-selected').children().length >0){
        $('.popup-selected').children()[0].style.borderTop = 'solid 6px #003c71';
        $('.popup-selected').children()[0].style.marginTop = '2px';
        $('.popup-selected').parent()[0].style.borderTop = 'solid 6px #ffffff';
        
      }
      $('.popup-selected').removeClass('popup-selected');
      
      $('#'+marker.id).addClass('popup-selected');
      if($('#'+marker.id).children().length>0){
        $('#'+marker.id).children()[0]['style']['display'] = 'block';
        $('#'+marker.id).children()[0].style.borderTop = 'solid 6px #ffffff';
        $('#'+marker.id).children()[0].style.marginTop = '2px';
        $('#'+marker.id).parent()[0].style.borderTop = 'solid 6px #003c71';
      }
    }
      

    /**
     * Filter lại place theo dk lọc
     */
    combineFilterAndCount(datalist){
      var se = this;
      let data = [...datalist];
        let databeforefilter = [...datalist];
        se.dataafterfilter = databeforefilter;
      if(databeforefilter && databeforefilter.length >0){
        if(se.searchhotel.ef_arrlocalcheck && se.searchhotel.ef_arrlocalcheck.length >0){
          let strlocalcheck = se.searchhotel.ef_arrlocalcheck.join(',');
          se.dataafterfilter = se.searchhotel.ef_arrlocalcheck.length >0 ? se.getFilterDataLocal(databeforefilter, se.searchhotel.ef_arrlocalcheck) : databeforefilter;
        }
        //countfilter theo khu vực con
        if(se.searchhotel.ef_arrsubregioncheck && se.searchhotel.ef_arrsubregioncheck.length >0){
          let strsubregioncheck = se.searchhotel.ef_arrsubregioncheck.join(',');
          se.dataafterfilter = se.searchhotel.ef_arrsubregioncheck.length >0 ? se.getFilterDataSubRegion(databeforefilter, se.searchhotel.ef_arrsubregioncheck) : databeforefilter;
        }
        //countfilter theo loại hình
          let strhoteltypecheck = se.searchhotel.ef_arrhoteltypecheck.join(',');
          if(se.dataafterfilter && se.dataafterfilter.length>0){
            se.dataafterfilter = se.searchhotel.ef_arrhoteltypecheck.length >0 ? se.getFilterDataHotelType(se.dataafterfilter, se.searchhotel.ef_arrhoteltypecheck) : se.dataafterfilter;
          }
          //countfilter theo giờ mở cửa
          if(se.dataafterfilter && se.dataafterfilter.length>0){
            se.dataafterfilter = se.searchhotel.ef_arrhouropencheck.length >0 ? se.getFilterDataByOpenHour(se.dataafterfilter, se.searchhotel.ef_arrhouropencheck) : se.dataafterfilter;
          }
          //countfilter theo khoảng cách
          if(se.dataafterfilter && se.dataafterfilter.length>0){
            se.dataafterfilter = se.searchhotel.ef_arrdistancecheck.length >0 ? se.getFilterDataByDistance(se.dataafterfilter, se.searchhotel.ef_arrdistancecheck) : se.dataafterfilter;
          }
          //countfilter theo phong cách
          let strstyle = se.searchhotel.ef_arrstylecheck.join(',');
          if(se.dataafterfilter && se.dataafterfilter.length>0){
            //let arrfilter = se.dataafterfilter.map((item) => { return item.tags})
            se.dataafterfilter = se.searchhotel.ef_arrstylecheck.length >0 ? se.dataafterfilter.filter((e:any) => { return se.searchhotel.ef_arrstylecheck.filter( it => { return e.tags.includes(it)}).length >0 }) : se.dataafterfilter;
          }
    
          //se.recountFilter(se.dataafterfilter);
          return se.dataafterfilter;
      }
    }

    combineDataPlace(regioncode, listmapdata) : Promise<any>{
      var se = this;
      return new Promise((resolve, reject) =>{
        //vào trang chi tiết nếu chọn 1 địa điểm ko phải vùng
        // if(se.searchhotel.inputExperienceItem && se.searchhotel.inputExperienceItem.placeId){
        //     return resolve(listmapdata);
        // }else{
            var strURL_CountFilter = C.urls.baseUrl.urlMobile + '/api/Data/CountFilterPlace?regionCodes=' + regioncode;
            se.gf.RequestApi('GET',strURL_CountFilter, {}, {}, "experienceFilter","CountFilterPlace").then((data:any)=>{
              if(data && data.data.length >0){
                    var datalist = listmapdata.map((item, row)=> {
                      const found:any = data.data.find((el) => {return el.id == item.id });
                      var newitem = { id: found.id, childRegionId :found.childRegionId, subRegionId: found.subRegionId,tags: found.tags};
                      return {...item,...newitem};
                    })
                return resolve(datalist);
              }
            })
          //}
        
      })
      
    }

    getFilterDataByDistance(listdata, arrdistance){
      var se = this;
      var listfilter = [...listdata];
      var listresult:any = [];
      arrdistance.forEach(d => {
        let list = listfilter.filter((e:any) => { return se.getWhereByDistance(e, d) });
        if(list && list.length>0 ){
          listresult.push(...list);
        }
      });
      return listresult;
    }
    
    getWhereByDistance(item, distance){
      if(distance == 1){
        return item.totalDistance >=0 && item.totalDistance < 1;
      }
      else if(distance == 2){
        return item.totalDistance >=1 && item.totalDistance < 5;
      }
      else if(distance == 3){
        return item.totalDistance >=5 && item.totalDistance < 10;
      }
      else if(distance == 4){
        return item.totalDistance >=10 && item.totalDistance < 20;
      }
    }

    getFilterDataByOpenHour(listdata, arropenhour){
      var se = this;
      var listfilter = [...listdata];
      var listresult:any = [];
      arropenhour.forEach(h => {
        let list = se.filterOpenHourWithworkinghoursId(listdata, h);
        if(list && list.length>0 ){
          if(listresult.length ==0){
            listresult.push(...list);
          }else {
            list.forEach(element => {
              if(!se.gf.checkExistsItemInArray(listresult, element, 'searchexperience')){
                listresult.push(element);
              }
            });
            
          }
          
        }
      });
      return listresult;
    }

    getFilterDataHotelType(listdata, arrhoteltype){
      var se = this;
      var listfilter = [...listdata];
      var listresult:any = [];
      arrhoteltype.forEach(ht => {
        let list = listfilter.filter((el)=>{ return el.tags.includes(ht)})
        if(list && list.length>0 ){
          if(listresult.length ==0){
            listresult.push(...list);
          }else {
            list.forEach(element => {
              if(!se.gf.checkExistsItemInArray(listresult, element, 'searchexperience')){
                listresult.push(element);
              }
            });
            
          }
          
        }
      });
      return listresult;
    }
    
    getFilterDataLocal(listdata, arrlocal){
      var se = this;
      var listfilter = [...listdata];
      var listresult:any = [];
      arrlocal.forEach(localid => {
        let list = listfilter.filter((el)=>{ return el.childRegionId == localid})
        if(list && list.length>0 ){
          if(listresult.length ==0){
            listresult.push(...list);
          }else {
            list.forEach(element => {
              if(!se.gf.checkExistsItemInArray(listresult, element, 'searchexperience')){
                listresult.push(element);
              }
            });
            
          }
          
        }
      });
      return listresult;
    }
    
    getFilterDataSubRegion(listdata, arrlocal){
      var se = this;
      var listfilter = [...listdata];
      var listresult:any = [];
      arrlocal.forEach(subregionid => {
        let list = listfilter.filter((el)=>{ return el.subRegionId == subregionid })
        if(list && list.length>0 ){
          if(listresult.length ==0){
            listresult.push(...list);
          }else {
            list.forEach(element => {
              if(!se.gf.checkExistsItemInArray(listresult, element, 'searchexperience')){
                listresult.push(element);
              }
            });
            
          }
          
        }
      });
      return listresult;
    }

    /**
   * Lọc list dữ liệu theo khung giờ hoạt động để đếm số địa điểm
   * @param data list dữ liệu
   */
  filterOpenHourWithworkinghoursId(data, workinghoursId){
    var se = this;
    return data.filter((el)=>{
      if(el.workingHours.length >1){
        let wk0 = el.workingHours[0];
        let wk1 = el.workingHours[1];
        if(wk0){
          if(wk0.name.indexOf('24/24') != -1){
            return true;
          }if(wk0.name.indexOf('đêm') != -1){
            let fromTimeFirst = wk0.timeFrom.replace(':','');
            let toTimeFirst = '2400';
            let fromTimeSecond = '0000';
            let toTimeSecond = wk0.timeTo.replace(':','');
            return (se.getTimeFilterWithworkinghoursId(fromTimeFirst, toTimeFirst, workinghoursId) || se.getTimeFilterWithworkinghoursId(fromTimeSecond, toTimeSecond, workinghoursId) );
          }
          else{
            let fromTime = wk0.timeFrom.replace(':','');
            let toTime = wk0.timeTo.replace(':','');
            return se.getTimeFilterWithworkinghoursId(fromTime, toTime, workinghoursId);
          }
        }

        if(wk1){
          if(wk1.name.indexOf('24/24') != -1){
            return true;
          }if(wk1.name.indexOf('đêm') != -1){
            let fromTimeFirst = wk1.timeFrom.replace(':','');
            let toTimeFirst = '2400';
            let fromTimeSecond = '0000';
            let toTimeSecond = wk1.timeTo.replace(':','');
            return (se.getTimeFilterWithworkinghoursId(fromTimeFirst, toTimeFirst, workinghoursId) || se.getTimeFilterWithworkinghoursId(fromTimeSecond, toTimeSecond, workinghoursId) );
          }
          else{
            let fromTime = wk1.timeFrom.replace(':','');
            let toTime = wk1.timeTo.replace(':','');
            return se.getTimeFilterWithworkinghoursId(fromTime, toTime, workinghoursId);
          }
        }
        
      }else{
        if(el.workingHours[0].name.indexOf('24/24') != -1){
          return true;
        }if(el.workingHours[0].name.indexOf('đêm') != -1){
          let fromTimeFirst = el.workingHours[0].timeFrom.replace(':','');
          let toTimeFirst = '2400';
          let fromTimeSecond = '0000';
          let toTimeSecond = el.workingHours[0].timeTo.replace(':','');
          return (se.getTimeFilterWithworkinghoursId(fromTimeFirst, toTimeFirst, workinghoursId) || se.getTimeFilterWithworkinghoursId(fromTimeSecond, toTimeSecond, workinghoursId) );
        }
        else{
          let fromTime = el.workingHours[0].timeFrom.replace(':','');
          let toTime = el.workingHours[0].timeTo.replace(':','');
          return se.getTimeFilterWithworkinghoursId(fromTime, toTime, workinghoursId);
        }
      }
      
    })
  }

  getTimeFilterWithworkinghoursId(fromTime, toTime,workinghoursId){
    var se = this;
    let minFromTime ='';
    let maxToTime='';
    minFromTime = se.getMinFromTime(workinghoursId);
    maxToTime = se.getMaxToTime(workinghoursId);

    return  (minFromTime >= fromTime && minFromTime <= toTime && maxToTime >= fromTime && maxToTime <= toTime) || (fromTime >= minFromTime && fromTime <= maxToTime && toTime >= minFromTime && toTime <= maxToTime || (fromTime >= minFromTime && fromTime <= maxToTime && toTime > maxToTime) ||(toTime >= minFromTime && toTime <= maxToTime) );
  }

  /**
   * Tính khoảng cách giữa các điểm so với vị trí hiện tại
   * @rest: item cần sort
   * @sortColumn: tên cột dữ liệu sort
   */
  calculateDistanceMapData(data) : Promise<any>{
    var se = this, sortColumn = 'totalDistance';
    return new Promise((resolve, reject) => {
      data.forEach(rest => {
          if(!rest.latitude || !rest.longitude){
            rest[sortColumn] =0;
          }else{
              if(se.deviceLocation.latitude && se.deviceLocation.longitude && !se.searchhotel.inputExperienceItem){
                let distancekm = (Math.round(L.latLng(se.deviceLocation.latitude, se.deviceLocation.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000);
                if(distancekm < 50){
                  rest[sortColumn] = (Math.round(L.latLng(se.deviceLocation.latitude, se.deviceLocation.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
                }else{
                  rest[sortColumn] = (Math.round(L.latLng(se.locationCoords.latitude, se.locationCoords.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
                }
              }else{
                rest[sortColumn] = (Math.round(L.latLng(se.locationCoords.latitude, se.locationCoords.longitude).distanceTo(L.latLng(rest.latitude, rest.longitude)))/1000).toFixed(1);
              }
          }
        })
       setTimeout(()=>{
        resolve(data);
       },200) 
    });
  }

}
